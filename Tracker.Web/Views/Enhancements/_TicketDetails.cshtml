@model TicketDetailsViewModel

<form id="ticketDetailsForm">
    @Html.AntiForgeryToken()
    <input type="hidden" name="Id" value="@Model.Id" />
    <input type="hidden" name="ServiceAreaId" value="@Model.ServiceAreaId" />

    <div class="row g-3">
        <!-- Core Fields -->
        <div class="col-md-4">
            <label class="form-label">Work ID <span class="text-danger">*</span></label>
            <input type="text" name="WorkId" value="@Model.WorkId" class="form-control" required maxlength="50" />
        </div>
        
        <div class="col-md-4">
            <label class="form-label">Service Area</label>
            <select name="ServiceAreaId" class="form-select" disabled>
                @foreach (var sa in Model.AvailableServiceAreas)
                {
                    <option value="@sa.Id" selected="@(sa.Id == Model.ServiceAreaId)">@sa.Name</option>
                }
            </select>
        </div>
        
        <div class="col-md-4">
            <label class="form-label">Status</label>
            <select name="Status" class="form-select">
                @foreach (var status in Model.AvailableStatuses)
                {
                    <option value="@status" selected="@(status == Model.Status)">@status</option>
                }
            </select>
        </div>
        
        <div class="col-12">
            <label class="form-label">Description</label>
            <input type="text" name="Description" value="@Model.Description" class="form-control" maxlength="500" />
        </div>
        
        <div class="col-12">
            <label class="form-label">Quick Notes</label>
            <textarea name="Notes" class="form-control" rows="2">@Model.Notes</textarea>
            <small class="text-muted">For detailed timestamped notes, use the Notes tab.</small>
        </div>

        <!-- Estimation Section -->
        <div class="col-12">
            <hr />
            <h6 class="text-muted"><i class="bi bi-calculator me-1"></i> Estimation</h6>
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Est. Hours</label>
            <input type="number" name="EstimatedHours" value="@Model.EstimatedHours" step="0.5" class="form-control" />
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Est. Start</label>
            <input type="date" name="EstimatedStartDate" value="@Model.EstimatedStartDate?.ToString("yyyy-MM-dd")" class="form-control" />
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Est. End</label>
            <input type="date" name="EstimatedEndDate" value="@Model.EstimatedEndDate?.ToString("yyyy-MM-dd")" class="form-control" />
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Service Line</label>
            <input type="text" name="ServiceLine" value="@Model.ServiceLine" class="form-control" list="serviceLineList" />
            <datalist id="serviceLineList">
                @foreach (var sl in Model.AvailableServiceLines)
                {
                    <option value="@sl" />
                }
            </datalist>
        </div>
        
        <div class="col-12">
            <label class="form-label">Estimation Notes</label>
            <textarea name="EstimationNotes" class="form-control" rows="2">@Model.EstimationNotes</textarea>
        </div>

        <!-- Actual/Returned Section -->
        <div class="col-12">
            <hr />
            <h6 class="text-muted"><i class="bi bi-check2-circle me-1"></i> Actual / Returned</h6>
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Returned Hours</label>
            <input type="number" name="ReturnedHours" value="@Model.ReturnedHours" step="0.5" class="form-control" />
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input type="date" name="StartDate" value="@Model.StartDate?.ToString("yyyy-MM-dd")" class="form-control" />
        </div>
        
        <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input type="date" name="EndDate" value="@Model.EndDate?.ToString("yyyy-MM-dd")" class="form-control" />
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Inf Status</label>
            <input type="text" name="InfStatus" value="@Model.InfStatus" class="form-control" list="infStatusList" />
            <datalist id="infStatusList">
                @foreach (var s in Model.AvailableInfStatuses)
                {
                    <option value="@s" />
                }
            </datalist>
        </div>

        <!-- Resources Section -->
        <div class="col-12">
            <hr />
            <h6 class="text-muted"><i class="bi bi-people me-1"></i> Resources</h6>
        </div>
        
        <div class="col-md-4">
            <label class="form-label">Sponsors</label>
            <select name="SponsorIds" class="form-select" multiple size="4">
                @foreach (var r in Model.AvailableSponsors)
                {
                    <option value="@r.Id" selected="@Model.SelectedSponsorIds.Contains(r.Id)">@r.Name</option>
                }
            </select>
        </div>
        
        <div class="col-md-4">
            <label class="form-label">SPOCs</label>
            <select name="SpocIds" class="form-select" multiple size="4">
                @foreach (var r in Model.AvailableSpocs)
                {
                    <option value="@r.Id" selected="@Model.SelectedSpocIds.Contains(r.Id)">@r.Name</option>
                }
            </select>
        </div>
        
        <div class="col-md-4">
            <label class="form-label">Assigned Resources</label>
            <select name="ResourceIds" class="form-select" multiple size="4">
                @foreach (var r in Model.AvailableResources)
                {
                    <option value="@r.Id" selected="@Model.SelectedResourceIds.Contains(r.Id)">@r.Name</option>
                }
            </select>
        </div>

        <!-- Skills Section -->
        @if (Model.AvailableSkills.Any())
        {
            <div class="col-12">
                <label class="form-label">Required Skills</label>
                <select name="SkillIds" class="form-select" multiple size="3">
                    @foreach (var skill in Model.AvailableSkills)
                    {
                        <option value="@skill.Id" selected="@Model.SelectedSkillIds.Contains(skill.Id)">@skill.Name</option>
                    }
                </select>
            </div>
        }

        <!-- Time Recording Categories Section -->
        <div class="col-12">
            <hr />
            <h6 class="text-muted"><i class="bi bi-grid-3x3 me-1"></i> Time Recording Categories</h6>
            <small class="text-muted d-block mb-2">Select business areas that apply to this enhancement. These will be the columns in the Time Recording tab.</small>
        </div>
        
        <div class="col-12">
            <div class="row">
                @foreach (var cat in Model.AvailableTimeCategories)
                {
                    <div class="col-md-3 col-sm-4 col-6">
                        <div class="form-check">
                            <input type="checkbox" name="TimeCategoryIds" value="@cat.Id" 
                                   class="form-check-input" id="cat_@cat.Id"
                                   checked="@Model.SelectedTimeCategoryIds.Contains(cat.Id)" />
                            <label class="form-check-label" for="cat_@cat.Id">
                                @cat.Name
                                @if (!string.IsNullOrEmpty(cat.Description))
                                {
                                    <i class="bi bi-info-circle text-muted" title="@cat.Description"></i>
                                }
                            </label>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Legacy Weekly Time (collapsible) -->
        <div class="col-12">
            <hr />
            <a class="text-muted small" data-bs-toggle="collapse" href="#legacyTimeSection">
                <i class="bi bi-chevron-down me-1"></i> Legacy Weekly Time Allocations
            </a>
        </div>
        
        <div class="collapse col-12" id="legacyTimeSection">
            <div class="row g-2 mt-2">
                @for (int i = 1; i <= 9; i++)
                {
                    var fieldName = $"TimeW{i}";
                    var fieldValue = (decimal?)Model.GetType().GetProperty(fieldName)?.GetValue(Model);
                    <div class="col">
                        <label class="form-label small">W@i</label>
                        <input type="number" name="@fieldName" value="@fieldValue" step="0.5" class="form-control form-control-sm" />
                    </div>
                }
            </div>
        </div>

        <!-- Audit Info -->
        @if (!string.IsNullOrEmpty(Model.Id))
        {
            <div class="col-12">
                <hr />
                <small class="text-muted">
                    Created: @Model.CreatedAt?.ToString("g") by @Model.CreatedBy
                    @if (Model.ModifiedAt.HasValue)
                    {
                        <span class="ms-3">Modified: @Model.ModifiedAt?.ToString("g") by @Model.ModifiedBy</span>
                    }
                </small>
            </div>
        }

        <!-- Save Button -->
        <div class="col-12">
            <hr />
            <button type="submit" class="btn btn-primary" id="saveDetailsBtn">
                <i class="bi bi-check-lg me-1"></i> Save
            </button>
            <span id="saveStatus" class="ms-2 text-success" style="display: none;">
                <i class="bi bi-check-circle"></i> Saved
            </span>
        </div>
    </div>
</form>

<script>
document.getElementById('ticketDetailsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    var form = this;
    var btn = document.getElementById('saveDetailsBtn');
    var status = document.getElementById('saveStatus');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';
    
    // Collect form data
    var formData = new FormData(form);
    var data = {
        id: formData.get('Id'),
        workId: formData.get('WorkId'),
        description: formData.get('Description'),
        notes: formData.get('Notes'),
        serviceAreaId: formData.get('ServiceAreaId'),
        estimatedHours: parseFloat(formData.get('EstimatedHours')) || null,
        estimatedStartDate: formData.get('EstimatedStartDate') || null,
        estimatedEndDate: formData.get('EstimatedEndDate') || null,
        estimationNotes: formData.get('EstimationNotes'),
        status: formData.get('Status'),
        serviceLine: formData.get('ServiceLine'),
        returnedHours: parseFloat(formData.get('ReturnedHours')) || null,
        startDate: formData.get('StartDate') || null,
        endDate: formData.get('EndDate') || null,
        infStatus: formData.get('InfStatus'),
        infServiceLine: formData.get('InfServiceLine'),
        timeW1: parseFloat(formData.get('TimeW1')) || null,
        timeW2: parseFloat(formData.get('TimeW2')) || null,
        timeW3: parseFloat(formData.get('TimeW3')) || null,
        timeW4: parseFloat(formData.get('TimeW4')) || null,
        timeW5: parseFloat(formData.get('TimeW5')) || null,
        timeW6: parseFloat(formData.get('TimeW6')) || null,
        timeW7: parseFloat(formData.get('TimeW7')) || null,
        timeW8: parseFloat(formData.get('TimeW8')) || null,
        timeW9: parseFloat(formData.get('TimeW9')) || null,
        sponsorIds: formData.getAll('SponsorIds'),
        spocIds: formData.getAll('SpocIds'),
        resourceIds: formData.getAll('ResourceIds'),
        skillIds: formData.getAll('SkillIds'),
        timeCategoryIds: formData.getAll('TimeCategoryIds')
    };
    
    fetch('@Url.Action("SaveDetails", "Enhancements")', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'RequestVerificationToken': antiForgeryToken 
        },
        body: JSON.stringify(data)
    })
    .then(function(r) { return r.json(); })
    .then(function(result) {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Save';
        
        if (result.success) {
            status.style.display = 'inline';
            setTimeout(function() { status.style.display = 'none'; }, 3000);
            
            // If new, redirect to details page
            if (!enhancementId && result.id) {
                window.location.href = '@Url.Action("Details", "Enhancements")/' + result.id + '?serviceAreaId=' + serviceAreaId;
            }
        } else {
            alert(result.message || 'Save failed');
        }
    })
    .catch(function(err) {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Save';
        alert('Error saving: ' + err.message);
    });
});
</script>
