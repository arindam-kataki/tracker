@model MyTimesheetViewModel
@{
    ViewData["Title"] = "My Timesheet";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">
        <i class="bi bi-clock-history me-2"></i>My Timesheet
        <small class="text-muted">- @Model.ResourceName</small>
    </h4>
    <button type="button" class="btn btn-primary" onclick="openAddEntry()">
        <i class="bi bi-plus-lg me-1"></i> Log Time
    </button>
</div>

<!-- Date Range Filter -->
<div class="card mb-4">
    <div class="card-body py-2">
        <form method="get" class="row g-2 align-items-center">
            <div class="col-auto">
                <label class="col-form-label">Period:</label>
            </div>
            <div class="col-auto">
                <input type="date" name="startDate" value="@Model.StartDate.ToString("yyyy-MM-dd")" class="form-control form-control-sm" />
            </div>
            <div class="col-auto">
                <span>to</span>
            </div>
            <div class="col-auto">
                <input type="date" name="endDate" value="@Model.EndDate.ToString("yyyy-MM-dd")" class="form-control form-control-sm" />
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-search"></i> Apply
                </button>
            </div>
            <div class="col-auto">
                <a href="@Url.Action("MyTimesheet")" class="btn btn-sm btn-outline-secondary">This Week</a>
            </div>
            <div class="col-auto ms-auto">
                <span class="badge bg-primary fs-6">
                    Total: @Model.TotalHours.ToString("N1") hrs
                </span>
                <span class="badge bg-success fs-6 ms-1">
                    Contributed: @Model.TotalContributedHours.ToString("N1") hrs
                </span>
            </div>
        </form>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-8">
        <!-- Time Entries -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul me-1"></i> Time Entries
            </div>
            <div class="card-body p-0">
                @if (!Model.Entries.Any())
                {
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-clock display-4"></i>
                        <p class="mt-2">No time entries for this period.</p>
                        <button type="button" class="btn btn-primary" onclick="openAddEntry()">
                            <i class="bi bi-plus-lg me-1"></i> Log Time
                        </button>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Enhancement</th>
                                    <th>Type</th>
                                    <th class="text-end">Hours</th>
                                    <th class="text-end">Contributed</th>
                                    <th>Notes</th>
                                    <th style="width: 80px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var entry in Model.Entries)
                                {
                                    var isConsolidated = entry.ConsolidationSources?.Any() == true;
                                    <tr class="@(isConsolidated ? "table-secondary" : "")">
                                        <td>
                                            @if (entry.StartDate == entry.EndDate)
                                            {
                                                @entry.StartDate.ToString("MMM d")
                                            }
                                            else
                                            {
                                                @($"{entry.StartDate:MMM d} - {entry.EndDate:MMM d}")
                                            }
                                        </td>
                                        <td>
                                            <span class="fw-semibold">@entry.Enhancement?.WorkId</span>
                                            <br />
                                            <small class="text-muted">@(entry.Enhancement?.Description?.Length > 40 ? entry.Enhancement.Description.Substring(0, 40) + "..." : entry.Enhancement?.Description)</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">@entry.WorkPhase?.Name</span>
                                        </td>
                                        <td class="text-end">@entry.Hours.ToString("N1")</td>
                                        <td class="text-end">@entry.ContributedHours.ToString("N1")</td>
                                        <td>
                                            <small class="text-muted">@(entry.Notes?.Length > 30 ? entry.Notes.Substring(0, 30) + "..." : entry.Notes)</small>
                                        </td>
                                        <td>
                                            @if (isConsolidated)
                                            {
                                                <span class="badge bg-info" title="This entry has been consolidated">
                                                    <i class="bi bi-lock"></i>
                                                </span>
                                            }
                                            else
                                            {
                                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                                        onclick="openEditEntry('@entry.Id')" title="Edit">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        onclick="deleteEntry('@entry.Id')" title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Hours by Type -->
        <div class="card mb-3">
            <div class="card-header">
                <i class="bi bi-pie-chart me-1"></i> Hours by Type
            </div>
            <div class="card-body">
                @if (Model.HoursByPhase.Any())
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var phase in Model.HoursByPhase.OrderByDescending(p => p.Value))
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                @phase.Key
                                <span class="badge bg-primary rounded-pill">@phase.Value.ToString("N1") hrs</span>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted mb-0">No data</p>
                }
            </div>
        </div>
        
        <!-- Quick Add -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-lightning me-1"></i> Quick Add
            </div>
            <div class="card-body">
                <p class="small text-muted mb-2">Select an enhancement to log time:</p>
                @if (Model.AssignedEnhancements.Any())
                {
                    <div class="list-group">
                        @foreach (var enh in Model.AssignedEnhancements.Take(5))
                        {
                            <a href="#" class="list-group-item list-group-item-action" 
                               onclick="openAddEntryForEnhancement('@enh.Id'); return false;">
                                <strong>@enh.WorkId</strong>
                                <br />
                                <small class="text-muted">@(enh.Description?.Length > 40 ? enh.Description.Substring(0, 40) + "..." : enh.Description)</small>
                            </a>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted small">No assigned enhancements.</p>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal for Add/Edit Entry -->
<div class="modal fade" id="entryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" id="entryModalContent">
            <!-- Loaded via AJAX -->
        </div>
    </div>
</div>

@section Scripts {
<script>
    function openAddEntry() {
        loadModal('/timesheet/entry/edit');
    }
    
    function openAddEntryForEnhancement(enhancementId) {
        loadModal('/timesheet/entry/edit?enhancementId=' + enhancementId);
    }
    
    function openEditEntry(id) {
        loadModal('/timesheet/entry/edit?id=' + id);
    }
    
    function loadModal(url) {
        fetch(url)
            .then(response => response.text())
            .then(html => {
                document.getElementById('entryModalContent').innerHTML = html;
                var modal = new bootstrap.Modal(document.getElementById('entryModal'));
                modal.show();
            });
    }
    
    function deleteEntry(id) {
        if (!confirm('Are you sure you want to delete this time entry?')) return;
        
        fetch('/timesheet/entry/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
            },
            body: 'id=' + encodeURIComponent(id)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Error deleting entry');
            }
        });
    }
    
    function saveEntry(form) {
        var formData = new FormData(form);
        
        fetch('/timesheet/entry/save', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('entryModal')).hide();
                location.reload();
            } else {
                alert(data.message || 'Error saving entry');
            }
        });
        
        return false;
    }
    
    // Update contributed hours when work phase changes
    function onWorkPhaseChange(select) {
        var phaseId = select.value;
        var hoursInput = document.querySelector('input[name="Hours"]');
        var contributedInput = document.querySelector('input[name="ContributedHours"]');
        
        if (!phaseId || !hoursInput.value) return;
        
        fetch('/timesheet/workphase/' + phaseId + '/contribution')
            .then(response => response.json())
            .then(data => {
                var hours = parseFloat(hoursInput.value) || 0;
                var contributed = hours * (data.contributionPercent / 100);
                contributedInput.value = contributed.toFixed(2);
            });
    }
    
    // Update contributed hours when hours change
    function onHoursChange(input) {
        var phaseSelect = document.querySelector('select[name="WorkPhaseId"]');
        if (phaseSelect && phaseSelect.value) {
            onWorkPhaseChange(phaseSelect);
        }
    }
</script>
@Html.AntiForgeryToken()
}
