@model MyTimesheetViewModel
@{
    ViewData["Title"] = "My Timesheet";
    var today = DateTime.Today;
    var firstDayOfMonth = new DateTime(Model.StartDate.Year, Model.StartDate.Month, 1);
    var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
    var startDayOfWeek = (int)firstDayOfMonth.DayOfWeek;
    var calendarStart = firstDayOfMonth.AddDays(-startDayOfWeek);
}

@* ============================================
   CUSTOM STYLES - Bigger fonts, unselectable calendar
   ============================================ *@
<style>
    /* Bigger fonts throughout */
    .timesheet-calendar {
        font-size: 1.05rem;
    }
    .timesheet-calendar .card-header {
        font-size: 1.1rem;
    }
    .timesheet-calendar .form-select,
    .timesheet-calendar .form-control {
        font-size: 1rem;
    }
    .timesheet-calendar .btn {
        font-size: 1rem;
    }
    
    /* Calendar specific - unselectable */
    .calendar-grid {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }
    .calendar-day {
        cursor: pointer;
        min-height: 70px;
        font-size: 1.1rem;
        transition: background-color 0.15s;
    }
    .calendar-day:hover {
        background-color: #e9ecef;
    }
    .calendar-day.today {
        background-color: #fff3cd;
        font-weight: bold;
    }
    .calendar-day.selected {
        background-color: #0d6efd;
        color: white;
    }
    .calendar-day.range-selected {
        background-color: #ffc107;
        color: #212529;
    }
    .calendar-day.has-hours {
        background-color: #d1e7dd;
    }
    .calendar-day.has-hours.selected {
        background-color: #0d6efd;
        color: white;
    }
    .calendar-day.other-month {
        opacity: 0.4;
    }
    .calendar-day .day-number {
        font-weight: 600;
        font-size: 1.15rem;
    }
    .calendar-day .hours-badge {
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    /* Day names header */
    .calendar-header th {
        font-size: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Filter section */
    .filter-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
    }
    .filter-section label {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
    }
    
    /* Totals display */
    .totals-display {
        font-size: 1.2rem;
        font-weight: 600;
    }
    
    /* Notes field - make it prominent */
    .notes-field {
        min-height: 60px;
        font-size: 1rem;
    }
    .notes-label {
        font-weight: 600;
        color: #495057;
    }
    .notes-label i {
        color: #ffc107;
    }
    
    /* Entry form */
    .entry-row {
        background-color: #f8f9fa;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    
    /* Info messages */
    .info-message {
        font-size: 1rem;
        padding: 1rem;
    }
</style>

<div class="container-fluid timesheet-calendar">
    @Html.AntiForgeryToken()
    
    @* ============================================
       PAGE HEADER
       ============================================ *@
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">
            <i class="bi bi-calendar3 me-2"></i>My Timesheet
        </h4>
        <div>
            <span class="text-muted me-3" style="font-size: 1.1rem;">@Model.ResourceName</span>
        </div>
    </div>

    @* ============================================
       FILTER SECTION - Service Area, Work Item, Clear
       ============================================ *@
    <div class="filter-section mb-3">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="serviceAreaFilter" class="form-label">
                    <i class="bi bi-diagram-3 me-1"></i>Service Area
                </label>
                <select id="serviceAreaFilter" class="form-select" onchange="onServiceAreaChange()">
                    <option value="">-- All Service Areas --</option>
                    @foreach (var sa in Model.AvailableServiceAreas)
                    {
                        <option value="@sa.Id" data-code="@sa.Code">@sa.Code - @sa.Name</option>
                    }
                </select>
            </div>
            
            <div class="col-md-5">
                <label for="workItemFilter" class="form-label">
                    <i class="bi bi-file-earmark-text me-1"></i>Work Item
                </label>
                <select id="workItemFilter" class="form-select" onchange="onWorkItemChange()" disabled>
                    <option value="">-- Select Service Area First --</option>
                </select>
            </div>
            
            <div class="col-md-3">
                <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                    <i class="bi bi-x-circle me-1"></i>Clear Filters
                </button>
            </div>
        </div>
        
        @* Status message showing current filter state *@
        <div class="mt-2">
            <span id="filterStatus" class="text-muted" style="font-size: 0.95rem;">
                <i class="bi bi-info-circle me-1"></i>Showing totals for all work items. Select a work item to add hours.
            </span>
        </div>
    </div>

    @* ============================================
       TOTALS DISPLAY - Shows based on filter selection
       ============================================ *@
    <div class="card mb-3" id="totalsCard">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-bar-chart me-2"></i><span id="totalsTitle">Monthly Totals</span></span>
            <span class="badge bg-primary totals-display" id="monthTotalBadge">0.0 hrs</span>
        </div>
        <div class="card-body py-2">
            <div class="row text-center" id="totalsBreakdown">
                <div class="col">
                    <div class="text-muted small">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        @* ============================================
           LEFT: CALENDAR
           ============================================ *@
        <div class="col-lg-7">
            <div class="card">
                @* Calendar Header with Navigation *@
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeMonth(-1)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <div>
                        <h5 class="mb-0 d-inline" id="calendarMonthTitle" style="font-size: 1.25rem;">
                            @Model.StartDate.ToString("MMMM yyyy")
                        </h5>
                        <button class="btn btn-sm btn-link" onclick="goToToday()">Today</button>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeMonth(1)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                
                <div class="card-body p-2">
                    @* Instructions *@
                    <div class="alert alert-info py-2 mb-2 info-message" id="calendarInstructions">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>Click</strong> a day to view/edit entries. 
                        <strong>Shift+Click</strong> to select a range for bulk entry.
                        <span id="addHoursWarning" class="text-danger d-none">
                            <br><i class="bi bi-exclamation-triangle me-1"></i>Select a specific work item above to add hours.
                        </span>
                    </div>
                    
                    @* Calendar Grid *@
                    <div id="calendarContainer" class="calendar-grid">
                        <table class="table table-bordered mb-0">
                            <thead class="calendar-header">
                                <tr>
                                    <th class="text-center py-2">Sun</th>
                                    <th class="text-center py-2">Mon</th>
                                    <th class="text-center py-2">Tue</th>
                                    <th class="text-center py-2">Wed</th>
                                    <th class="text-center py-2">Thu</th>
                                    <th class="text-center py-2">Fri</th>
                                    <th class="text-center py-2">Sat</th>
                                </tr>
                            </thead>
                            <tbody id="calendarBody">
                                @* Calendar days rendered by JavaScript *@
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        @* ============================================
           RIGHT: DAY PANEL (Single Day or Bulk Entry)
           ============================================ *@
        <div class="col-lg-5">
            @* No Work Item Selected Panel *@
            <div id="noWorkItemPanel" class="card">
                <div class="card-header">
                    <i class="bi bi-hand-index me-1"></i>
                    <strong>Select a Work Item</strong>
                </div>
                <div class="card-body text-center py-5">
                    <i class="bi bi-calendar-plus display-4 text-muted d-block mb-3"></i>
                    <p class="text-muted mb-0">
                        Select a <strong>Service Area</strong> and <strong>Work Item</strong> above to add time entries.
                    </p>
                    <p class="text-muted small mt-2">
                        You can view totals without selecting a work item, but adding hours requires a specific work item.
                    </p>
                </div>
            </div>

            @* Single Day Panel *@
            <div id="singleDayPanel" class="card" style="display: none;">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-calendar-day me-1"></i>
                    <strong id="singleDayTitle">Select a day</strong>
                </div>
                <div class="card-body">
                    @* Existing entries for this day *@
                    <div id="dayEntriesList" class="mb-3">
                        <p class="text-muted">Loading...</p>
                    </div>
                    
                    @* Add Entry Form *@
                    <div id="addEntryForm">
                        <hr />
                        <h6 class="mb-3"><i class="bi bi-plus-circle me-1 text-success"></i>Add New Entry</h6>
                        
                        <div class="entry-row">
                            <div class="row g-2 mb-2">
                                <div class="col-md-6">
                                    <label class="form-label small">Work Type <span class="text-danger">*</span></label>
                                    <select id="newEntryWorkPhase" class="form-select" onchange="updateNewEntryContributed()">
                                        <option value="">-- Select --</option>
                                        @foreach (var wp in Model.WorkPhases)
                                        {
                                            <option value="@wp.Id" data-contribution="@wp.DefaultContributionPercent">@wp.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Hours <span class="text-danger">*</span></label>
                                    <input type="number" id="newEntryHours" class="form-control" 
                                           step="0.25" min="0.25" placeholder="0.00" onchange="updateNewEntryContributed()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Contributed</label>
                                    <input type="number" id="newEntryContributed" class="form-control" 
                                           step="0.25" min="0" placeholder="0.00" readonly>
                                </div>
                            </div>
                            
                            @* Notes on its own row - prominent! *@
                            <div class="mb-2">
                                <label class="form-label small notes-label">
                                    <i class="bi bi-chat-left-text me-1"></i>Notes / Comments <span class="text-muted">(Important!)</span>
                                </label>
                                <textarea id="newEntryNotes" class="form-control notes-field" 
                                          rows="2" placeholder="Describe the work done... (comments are important for tracking!)"></textarea>
                            </div>
                            
                            <div class="d-grid">
                                <button type="button" class="btn btn-success" onclick="saveNewEntry()">
                                    <i class="bi bi-plus-lg me-1"></i>Add Entry
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @* Bulk Entry Panel (Range Selection) *@
            <div id="rangeDayPanel" class="card" style="display: none;">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-calendar-range me-1"></i>
                    <strong id="rangeDayTitle">Bulk Entry</strong>
                    <span class="badge bg-dark float-end" id="rangeDayCount">0 days</span>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning py-2 mb-3 info-message">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Entries will be created for <strong>each day</strong> in the selected range.
                    </div>
                    
                    @* Bulk entries table *@
                    <table class="table table-sm mb-3">
                        <thead>
                            <tr>
                                <th>Work Type</th>
                                <th style="width: 80px;">Hours</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="bulkEntriesBody">
                            @* Rows added dynamically *@
                        </tbody>
                    </table>
                    
                    <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addBulkEntryRow()">
                        <i class="bi bi-plus me-1"></i>Add Row
                    </button>
                    
                    @* Notes for bulk entry - on its own row, prominent! *@
                    <div class="mb-3">
                        <label class="form-label notes-label">
                            <i class="bi bi-chat-left-text me-1"></i>Notes / Comments <span class="text-muted">(Applied to all entries)</span>
                        </label>
                        <textarea id="bulkEntryNotes" class="form-control notes-field" 
                                  rows="2" placeholder="Describe the work done... (comments are important for tracking!)"></textarea>
                    </div>
                    
                    @* Preview and Save *@
                    <div class="alert alert-secondary py-2 mb-3">
                        <span id="bulkPreviewText">0 days × 0 hrs/day = 0 hours total</span>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary flex-fill" onclick="cancelBulkEntry()">
                            <i class="bi bi-x me-1"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-success flex-fill" id="saveBulkBtn" onclick="saveBulkEntries()">
                            <i class="bi bi-check-lg me-1"></i>Create Entries
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Edit Entry Modal *@
<div class="modal fade" id="editEntryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editEntryId" />
                
                <div class="row g-2 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Work Type</label>
                        <select id="editWorkPhase" class="form-select" onchange="updateEditContributed()">
                            @foreach (var wp in Model.WorkPhases)
                            {
                                <option value="@wp.Id" data-contribution="@wp.DefaultContributionPercent">@wp.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Hours</label>
                        <input type="number" id="editHours" class="form-control" step="0.25" min="0.25" onchange="updateEditContributed()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Contributed</label>
                        <input type="number" id="editContributed" class="form-control" step="0.25" min="0">
                    </div>
                </div>
                
                @* Notes on its own row *@
                <div class="mb-3">
                    <label class="form-label notes-label">
                        <i class="bi bi-chat-left-text me-1"></i>Notes / Comments
                    </label>
                    <textarea id="editNotes" class="form-control notes-field" rows="3" 
                              placeholder="Describe the work done..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateEntry()">
                    <i class="bi bi-check-lg me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function() {
    // ============================================
    // STATE VARIABLES
    // ============================================
    let selectedServiceAreaId = null;
    let selectedWorkItem = null;  // { id, workId, description }
    let selectedDate = null;
    let selectedDateRange = [];
    let lastClickedDate = null;
    let currentMonth = new Date(@Model.StartDate.Year, @(Model.StartDate.Month - 1), 1);
    let calendarData = {};  // { 'YYYY-MM-DD': { hours, contributed, entries[] } }
    let bulkRowCounter = 0;
    
    // Work phases data (with camelCase for JS)
    let workPhases = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.WorkPhases.Select(wp => new { 
            id = wp.Id, 
            name = wp.Name, 
            defaultContributionPercent = wp.DefaultContributionPercent 
        })));
    
    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        loadCalendarGrid();
        loadTotals();
        updateFilterStatus();
    });
    
    // ============================================
    // FILTER HANDLERS
    // ============================================
    window.onServiceAreaChange = function() {
        const select = document.getElementById('serviceAreaFilter');
        selectedServiceAreaId = select.value || null;
        
        // Reset work item
        selectedWorkItem = null;
        const workItemSelect = document.getElementById('workItemFilter');
        
        if (selectedServiceAreaId) {
            // Load work items for this service area
            workItemSelect.disabled = true;
            workItemSelect.innerHTML = '<option value="">Loading...</option>';
            
            fetch('/timesheet/enhancements?serviceAreaId=' + encodeURIComponent(selectedServiceAreaId))
                .then(r => r.json())
                .then(data => {
                    let options = '<option value="">-- Select Work Item --</option>';
                    data.forEach(item => {
                        // Format: WorkId - Description
                        const desc = item.description ? item.description.substring(0, 50) : '';
                        options += `<option value="${item.id}" data-workid="${item.workId}" data-desc="${item.description || ''}">${item.workId} - ${desc}${item.description && item.description.length > 50 ? '...' : ''}</option>`;
                    });
                    workItemSelect.innerHTML = options;
                    workItemSelect.disabled = false;
                })
                .catch(err => {
                    console.error('Error loading work items:', err);
                    workItemSelect.innerHTML = '<option value="">Error loading items</option>';
                });
        } else {
            workItemSelect.innerHTML = '<option value="">-- Select Service Area First --</option>';
            workItemSelect.disabled = true;
        }
        
        // Reset UI
        resetDayPanels();
        updateFilterStatus();
        loadCalendarGrid();
        loadTotals();
    };
    
    window.onWorkItemChange = function() {
        const select = document.getElementById('workItemFilter');
        const selectedOption = select.options[select.selectedIndex];
        
        if (select.value) {
            selectedWorkItem = {
                id: select.value,
                workId: selectedOption.dataset.workid,
                description: selectedOption.dataset.desc
            };
        } else {
            selectedWorkItem = null;
        }
        
        // Reset UI
        resetDayPanels();
        updateFilterStatus();
        loadCalendarGrid();
        loadTotals();
    };
    
    window.clearFilters = function() {
        selectedServiceAreaId = null;
        selectedWorkItem = null;
        
        document.getElementById('serviceAreaFilter').value = '';
        const workItemSelect = document.getElementById('workItemFilter');
        workItemSelect.innerHTML = '<option value="">-- Select Service Area First --</option>';
        workItemSelect.disabled = true;
        
        resetDayPanels();
        updateFilterStatus();
        loadCalendarGrid();
        loadTotals();
    };
    
    function resetDayPanels() {
        selectedDate = null;
        selectedDateRange = [];
        lastClickedDate = null;
        
        document.getElementById('noWorkItemPanel').style.display = selectedWorkItem ? 'none' : 'block';
        document.getElementById('singleDayPanel').style.display = 'none';
        document.getElementById('rangeDayPanel').style.display = 'none';
        
        // Update instructions
        const warning = document.getElementById('addHoursWarning');
        if (selectedWorkItem) {
            warning.classList.add('d-none');
        } else {
            warning.classList.remove('d-none');
        }
    }
    
    function updateFilterStatus() {
        const statusEl = document.getElementById('filterStatus');
        const titleEl = document.getElementById('totalsTitle');
        
        if (selectedWorkItem) {
            statusEl.innerHTML = `<i class="bi bi-check-circle text-success me-1"></i>Showing hours for: <strong>${selectedWorkItem.workId}</strong>. You can add hours.`;
            titleEl.textContent = `Hours for ${selectedWorkItem.workId}`;
        } else if (selectedServiceAreaId) {
            const saSelect = document.getElementById('serviceAreaFilter');
            const saName = saSelect.options[saSelect.selectedIndex].text;
            statusEl.innerHTML = `<i class="bi bi-funnel me-1"></i>Showing totals for: <strong>${saName}</strong>. Select a work item to add hours.`;
            titleEl.textContent = `Totals for ${saName}`;
        } else {
            statusEl.innerHTML = `<i class="bi bi-info-circle me-1"></i>Showing totals for <strong>all work items</strong>. Select a work item to add hours.`;
            titleEl.textContent = 'Monthly Totals (All Items)';
        }
    }
    
    // ============================================
    // CALENDAR GRID
    // ============================================
    function loadCalendarGrid() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDayOfWeek = firstDay.getDay();
        const calendarStart = new Date(firstDay);
        calendarStart.setDate(calendarStart.getDate() - startDayOfWeek);
        
        // Update header
        document.getElementById('calendarMonthTitle').textContent = 
            firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        let html = '';
        let current = new Date(calendarStart);
        
        for (let week = 0; week < 6; week++) {
            html += '<tr>';
            for (let day = 0; day < 7; day++) {
                const dateStr = current.toISOString().split('T')[0];
                const isCurrentMonth = current.getMonth() === month;
                const isToday = dateStr === new Date().toISOString().split('T')[0];
                
                let classes = 'calendar-day text-center p-2';
                if (!isCurrentMonth) classes += ' other-month';
                if (isToday) classes += ' today';
                
                html += `<td class="${classes}" data-date="${dateStr}" onclick="onDayClick(event, '${dateStr}')">
                    <div class="day-number">${current.getDate()}</div>
                </td>`;
                
                current.setDate(current.getDate() + 1);
            }
            html += '</tr>';
            
            // Stop if we've passed the last day of the month and completed the week
            if (current > lastDay && current.getDay() === 0) break;
        }
        
        document.getElementById('calendarBody').innerHTML = html;
        
        // Load calendar data (hours per day)
        loadCalendarData();
    }
    
    function loadCalendarData() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth() + 1;
        
        let url = `/timesheet/calendar-data?year=${year}&month=${month}`;
        
        if (selectedWorkItem) {
            url += `&enhancementId=${encodeURIComponent(selectedWorkItem.id)}`;
        } else if (selectedServiceAreaId) {
            url += `&serviceAreaId=${encodeURIComponent(selectedServiceAreaId)}`;
        }
        
        fetch(url)
            .then(r => r.json())
            .then(data => {
                calendarData = {};
                data.forEach(d => {
                    calendarData[d.date] = { hours: d.hours, contributed: d.contributed };
                });
                updateCalendarDisplay();
            })
            .catch(err => console.error('Error loading calendar data:', err));
    }
    
    function updateCalendarDisplay() {
        document.querySelectorAll('.calendar-day').forEach(dayEl => {
            const dateStr = dayEl.dataset.date;
            const dayData = calendarData[dateStr];
            
            // Remove existing badge
            const existingBadge = dayEl.querySelector('.hours-badge');
            if (existingBadge) existingBadge.remove();
            
            dayEl.classList.remove('has-hours');
            
            if (dayData && dayData.hours > 0) {
                dayEl.classList.add('has-hours');
                const badge = document.createElement('div');
                badge.className = 'hours-badge badge bg-success mt-1';
                badge.textContent = dayData.hours.toFixed(1) + 'h';
                dayEl.appendChild(badge);
            }
        });
    }
    
    // ============================================
    // TOTALS LOADING
    // ============================================
    function loadTotals() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth() + 1;
        
        let url = `/timesheet/monthly-totals?year=${year}&month=${month}`;
        
        if (selectedWorkItem) {
            url += `&enhancementId=${encodeURIComponent(selectedWorkItem.id)}`;
        } else if (selectedServiceAreaId) {
            url += `&serviceAreaId=${encodeURIComponent(selectedServiceAreaId)}`;
        }
        
        fetch(url)
            .then(r => r.json())
            .then(data => {
                // Update total badge
                document.getElementById('monthTotalBadge').textContent = 
                    (data.totalHours || 0).toFixed(1) + ' hrs';
                
                // Update breakdown
                let breakdownHtml = '';
                if (data.byWorkPhase && Object.keys(data.byWorkPhase).length > 0) {
                    breakdownHtml = '<div class="row">';
                    for (const [phase, hours] of Object.entries(data.byWorkPhase)) {
                        breakdownHtml += `<div class="col-auto"><span class="badge bg-secondary me-1">${phase}</span>${hours.toFixed(1)}h</div>`;
                    }
                    breakdownHtml += '</div>';
                } else {
                    breakdownHtml = '<span class="text-muted">No hours recorded this month</span>';
                }
                document.getElementById('totalsBreakdown').innerHTML = breakdownHtml;
            })
            .catch(err => {
                console.error('Error loading totals:', err);
                document.getElementById('totalsBreakdown').innerHTML = '<span class="text-danger">Error loading totals</span>';
            });
    }
    
    // ============================================
    // DAY CLICK HANDLING
    // ============================================
    window.onDayClick = function(event, dateStr) {
        // If no work item selected, can't add hours
        if (!selectedWorkItem) {
            alert('Please select a Service Area and Work Item above before adding time entries.');
            return;
        }
        
        if (event.shiftKey && lastClickedDate) {
            // Range selection for bulk entry
            selectDateRange(lastClickedDate, dateStr);
        } else {
            // Single day selection
            lastClickedDate = dateStr;
            selectSingleDate(dateStr);
        }
    };
    
    function selectSingleDate(dateStr) {
        selectedDate = dateStr;
        selectedDateRange = [];
        
        // Update calendar UI
        document.querySelectorAll('.calendar-day').forEach(d => {
            d.classList.remove('selected', 'range-selected');
        });
        const dayEl = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
        if (dayEl) dayEl.classList.add('selected');
        
        // Show single day panel
        document.getElementById('noWorkItemPanel').style.display = 'none';
        document.getElementById('singleDayPanel').style.display = 'block';
        document.getElementById('rangeDayPanel').style.display = 'none';
        
        // Update title
        const date = new Date(dateStr);
        document.getElementById('singleDayTitle').textContent = 
            date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        
        // Load entries for this day
        loadDayEntries(dateStr);
        
        // Clear add form
        document.getElementById('newEntryWorkPhase').value = '';
        document.getElementById('newEntryHours').value = '';
        document.getElementById('newEntryContributed').value = '';
        document.getElementById('newEntryNotes').value = '';
    }
    
    function selectDateRange(startStr, endStr) {
        let start = new Date(startStr);
        let end = new Date(endStr);
        
        if (start > end) {
            [start, end] = [end, start];
            [startStr, endStr] = [endStr, startStr];
        }
        
        selectedDate = null;
        selectedDateRange = [];
        
        // Build range
        let current = new Date(start);
        while (current <= end) {
            selectedDateRange.push(current.toISOString().split('T')[0]);
            current.setDate(current.getDate() + 1);
        }
        
        // Update calendar UI
        document.querySelectorAll('.calendar-day').forEach(d => {
            d.classList.remove('selected', 'range-selected');
            if (selectedDateRange.includes(d.dataset.date)) {
                d.classList.add('range-selected');
            }
        });
        
        // Show range panel
        document.getElementById('noWorkItemPanel').style.display = 'none';
        document.getElementById('singleDayPanel').style.display = 'none';
        document.getElementById('rangeDayPanel').style.display = 'block';
        
        // Update title
        const startDate = new Date(selectedDateRange[0]);
        const endDate = new Date(selectedDateRange[selectedDateRange.length - 1]);
        document.getElementById('rangeDayTitle').textContent = 
            `Bulk Entry: ${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
        document.getElementById('rangeDayCount').textContent = selectedDateRange.length + ' days';
        
        // Initialize bulk entry form
        initBulkEntryForm();
    }
    
    // ============================================
    // SINGLE DAY ENTRIES
    // ============================================
    function loadDayEntries(dateStr) {
        const listEl = document.getElementById('dayEntriesList');
        listEl.innerHTML = '<p class="text-muted"><i class="bi bi-hourglass-split"></i> Loading...</p>';
        
        fetch(`/timesheet/day-entries?date=${dateStr}&enhancementId=${encodeURIComponent(selectedWorkItem.id)}`)
            .then(r => r.json())
            .then(entries => {
                if (entries.length === 0) {
                    listEl.innerHTML = '<p class="text-muted text-center py-3"><i class="bi bi-inbox me-1"></i>No entries for this day</p>';
                    return;
                }
                
                let html = '<div class="list-group list-group-flush">';
                entries.forEach(e => {
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-start px-0">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <strong>${e.workPhaseName || 'Unknown'}</strong>
                                    <span class="badge bg-primary">${e.hours.toFixed(2)}h</span>
                                </div>
                                ${e.notes ? `<small class="text-muted d-block mt-1"><i class="bi bi-chat-left-text me-1"></i>${e.notes}</small>` : ''}
                            </div>
                            <div class="btn-group btn-group-sm ms-2">
                                <button class="btn btn-outline-primary" onclick="editEntry('${e.id}', '${e.workPhaseId}', ${e.hours}, ${e.contributedHours}, '${(e.notes || '').replace(/'/g, "\\'")}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteEntry('${e.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                listEl.innerHTML = html;
            })
            .catch(err => {
                console.error('Error loading entries:', err);
                listEl.innerHTML = '<p class="text-danger">Error loading entries</p>';
            });
    }
    
    window.updateNewEntryContributed = function() {
        const workPhaseSelect = document.getElementById('newEntryWorkPhase');
        const hoursInput = document.getElementById('newEntryHours');
        const contributedInput = document.getElementById('newEntryContributed');
        
        const selectedOption = workPhaseSelect.options[workPhaseSelect.selectedIndex];
        const contribution = parseInt(selectedOption?.dataset?.contribution) || 100;
        const hours = parseFloat(hoursInput.value) || 0;
        
        contributedInput.value = (hours * contribution / 100).toFixed(2);
    };
    
    window.saveNewEntry = function() {
        const workPhaseId = document.getElementById('newEntryWorkPhase').value;
        const hours = parseFloat(document.getElementById('newEntryHours').value);
        const contributed = parseFloat(document.getElementById('newEntryContributed').value);
        const notes = document.getElementById('newEntryNotes').value;
        
        if (!workPhaseId || !hours || hours <= 0) {
            alert('Please select a work type and enter hours.');
            return;
        }
        
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
        
        const formData = new URLSearchParams();
        formData.append('EnhancementId', selectedWorkItem.id);
        formData.append('WorkPhaseId', workPhaseId);
        formData.append('StartDate', selectedDate);
        formData.append('Hours', hours);
        formData.append('ContributedHours', contributed || hours);
        formData.append('Notes', notes);
        formData.append('__RequestVerificationToken', token);
        
        fetch('/timesheet/entry/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                // Clear form
                document.getElementById('newEntryWorkPhase').value = '';
                document.getElementById('newEntryHours').value = '';
                document.getElementById('newEntryContributed').value = '';
                document.getElementById('newEntryNotes').value = '';
                
                // Reload
                loadDayEntries(selectedDate);
                loadCalendarData();
                loadTotals();
            } else {
                alert(result.message || 'Error saving entry');
            }
        })
        .catch(err => {
            console.error('Error saving entry:', err);
            alert('Error saving entry');
        });
    };
    
    // ============================================
    // EDIT/DELETE ENTRY
    // ============================================
    window.editEntry = function(id, workPhaseId, hours, contributed, notes) {
        document.getElementById('editEntryId').value = id;
        document.getElementById('editWorkPhase').value = workPhaseId;
        document.getElementById('editHours').value = hours;
        document.getElementById('editContributed').value = contributed;
        document.getElementById('editNotes').value = notes;
        
        new bootstrap.Modal(document.getElementById('editEntryModal')).show();
    };
    
    window.updateEditContributed = function() {
        const workPhaseSelect = document.getElementById('editWorkPhase');
        const hoursInput = document.getElementById('editHours');
        const contributedInput = document.getElementById('editContributed');
        
        const selectedOption = workPhaseSelect.options[workPhaseSelect.selectedIndex];
        const contribution = parseInt(selectedOption?.dataset?.contribution) || 100;
        const hours = parseFloat(hoursInput.value) || 0;
        
        contributedInput.value = (hours * contribution / 100).toFixed(2);
    };
    
    window.updateEntry = function() {
        const id = document.getElementById('editEntryId').value;
        const workPhaseId = document.getElementById('editWorkPhase').value;
        const hours = parseFloat(document.getElementById('editHours').value);
        const contributed = parseFloat(document.getElementById('editContributed').value);
        const notes = document.getElementById('editNotes').value;
        
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
        
        const formData = new URLSearchParams();
        formData.append('Id', id);
        formData.append('WorkPhaseId', workPhaseId);
        formData.append('Hours', hours);
        formData.append('ContributedHours', contributed);
        formData.append('Notes', notes);
        formData.append('__RequestVerificationToken', token);
        
        fetch('/timesheet/entry/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                bootstrap.Modal.getInstance(document.getElementById('editEntryModal')).hide();
                loadDayEntries(selectedDate);
                loadCalendarData();
                loadTotals();
            } else {
                alert(result.message || 'Error updating entry');
            }
        });
    };
    
    window.deleteEntry = function(id) {
        if (!confirm('Delete this entry?')) return;
        
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
        
        const formData = new URLSearchParams();
        formData.append('id', id);
        formData.append('__RequestVerificationToken', token);
        
        fetch('/timesheet/entry/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                loadDayEntries(selectedDate);
                loadCalendarData();
                loadTotals();
            } else {
                alert(result.message || 'Error deleting entry');
            }
        });
    };
    
    // ============================================
    // BULK ENTRY
    // ============================================
    function initBulkEntryForm() {
        document.getElementById('bulkEntriesBody').innerHTML = '';
        document.getElementById('bulkEntryNotes').value = '';
        bulkRowCounter = 0;
        addBulkEntryRow();
        updateBulkPreview();
    }
    
    window.addBulkEntryRow = function() {
        const rowId = 'bulk_' + (++bulkRowCounter);
        
        // Build work phase options
        const options = workPhases.map(wp => 
            `<option value="${wp.id}" data-contribution="${wp.defaultContributionPercent}">${wp.name}</option>`
        ).join('');
        
        const row = document.createElement('tr');
        row.id = rowId;
        row.innerHTML = `
            <td>
                <select class="form-select form-select-sm bulk-workphase" onchange="updateBulkPreview()">
                    <option value="">Select...</option>
                    ${options}
                </select>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm bulk-hours" 
                       step="0.5" min="0.5" placeholder="0" onchange="updateBulkPreview()">
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBulkRow('${rowId}')">
                    <i class="bi bi-x"></i>
                </button>
            </td>
        `;
        
        document.getElementById('bulkEntriesBody').appendChild(row);
    };
    
    window.removeBulkRow = function(rowId) {
        document.getElementById(rowId)?.remove();
        updateBulkPreview();
    };
    
    window.updateBulkPreview = function() {
        let totalHoursPerDay = 0;
        document.querySelectorAll('#bulkEntriesBody tr').forEach(row => {
            const hours = parseFloat(row.querySelector('.bulk-hours')?.value) || 0;
            totalHoursPerDay += hours;
        });
        
        const days = selectedDateRange.length;
        const total = days * totalHoursPerDay;
        const rowCount = document.querySelectorAll('#bulkEntriesBody tr').length;
        
        document.getElementById('bulkPreviewText').textContent = 
            `${days} days × ${totalHoursPerDay.toFixed(1)} hrs/day = ${total.toFixed(1)} hours total`;
        document.getElementById('saveBulkBtn').textContent = 
            `Create ${days * rowCount} Entries`;
    };
    
    window.cancelBulkEntry = function() {
        selectedDateRange = [];
        document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('range-selected'));
        document.getElementById('rangeDayPanel').style.display = 'none';
        document.getElementById('noWorkItemPanel').style.display = selectedWorkItem ? 'none' : 'block';
    };
    
    window.saveBulkEntries = async function() {
        const entries = [];
        const notes = document.getElementById('bulkEntryNotes').value;
        
        document.querySelectorAll('#bulkEntriesBody tr').forEach(row => {
            const workPhaseId = row.querySelector('.bulk-workphase')?.value;
            const hours = parseFloat(row.querySelector('.bulk-hours')?.value) || 0;
            if (workPhaseId && hours > 0) {
                // Get contribution percentage
                const select = row.querySelector('.bulk-workphase');
                const contribution = parseInt(select.options[select.selectedIndex]?.dataset?.contribution) || 100;
                const contributed = hours * contribution / 100;
                
                entries.push({ workPhaseId, hours, contributed, notes });
            }
        });
        
        if (entries.length === 0) {
            alert('Please add at least one valid entry with work type and hours.');
            return;
        }
        
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
        let successCount = 0;
        let errorCount = 0;
        
        // Disable button during save
        const saveBtn = document.getElementById('saveBulkBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Saving...';
        
        // Create entries for each day and each work type
        for (const dateStr of selectedDateRange) {
            for (const entry of entries) {
                const formData = new URLSearchParams();
                formData.append('EnhancementId', selectedWorkItem.id);
                formData.append('WorkPhaseId', entry.workPhaseId);
                formData.append('StartDate', dateStr);
                formData.append('Hours', entry.hours);
                formData.append('ContributedHours', entry.contributed);
                formData.append('Notes', entry.notes);
                formData.append('__RequestVerificationToken', token);
                
                try {
                    const response = await fetch('/timesheet/entry/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData.toString()
                    });
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (err) {
                    errorCount++;
                }
            }
        }
        
        // Show result
        if (errorCount > 0) {
            alert(`Created ${successCount} entries. ${errorCount} failed.`);
        }
        
        // Reset and reload
        cancelBulkEntry();
        loadCalendarData();
        loadTotals();
    };
    
    // ============================================
    // CALENDAR NAVIGATION
    // ============================================
    window.changeMonth = function(delta) {
        currentMonth.setMonth(currentMonth.getMonth() + delta);
        resetDayPanels();
        loadCalendarGrid();
        loadTotals();
    };
    
    window.goToToday = function() {
        currentMonth = new Date();
        currentMonth.setDate(1);
        resetDayPanels();
        loadCalendarGrid();
        loadTotals();
    };
    
})();
</script>
}
