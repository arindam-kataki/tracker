@model MyTimesheetViewModel
@{
    ViewData["Title"] = "My Timesheet";
    var today = DateTime.Today;
    var firstDayOfMonth = new DateTime(Model.StartDate.Year, Model.StartDate.Month, 1);
    var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
    var startDayOfWeek = (int)firstDayOfMonth.DayOfWeek;
    var calendarStart = firstDayOfMonth.AddDays(-startDayOfWeek);
}

<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">
            <i class="bi bi-clock-history me-2"></i>My Timesheet
        </h4>
        <div>
            <span class="text-muted me-3">@Model.ResourceName</span>
            <span class="badge bg-secondary" id="monthTotalBadge">@Model.StartDate.ToString("MMMM yyyy"): @Model.TotalHours.ToString("N1") hrs</span>
        </div>
    </div>

    <!-- Enhancement Selection Bar -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="row align-items-center g-2">
                <div class="col-auto">
                    <span class="badge bg-primary rounded-pill">1</span>
                </div>
                <div class="col-md-2">
                    <select id="serviceAreaFilter" class="form-select form-select-sm" onchange="onServiceAreaChange()">
                        <option value="">All Service Areas</option>
                        @foreach (var sa in Model.AvailableServiceAreas)
                        {
                            <option value="@sa.Id">@sa.Code - @sa.Name</option>
                        }
                    </select>
                </div>
                <div class="col-auto">
                    <span class="badge bg-primary rounded-pill">2</span>
                </div>
                <div class="col-md-4">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="enhancementSearch" class="form-control" 
                               placeholder="Search enhancement by WorkId or description..." 
                               onkeyup="debounceEnhancementSearch()">
                    </div>
                </div>
                <div class="col">
                    <div id="selectedEnhancementDisplay" class="d-none">
                        <div class="d-flex align-items-center">
                            <div class="bg-success text-white px-2 py-1 rounded-start small">
                                <i class="bi bi-check-circle"></i>
                            </div>
                            <div class="bg-light border px-2 py-1 rounded-end flex-grow-1 small">
                                <strong id="selectedWorkId"></strong> - <span id="selectedDescription"></span>
                                <button type="button" class="btn btn-sm btn-link p-0 ms-2" onclick="clearEnhancement()">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="enhancementDropdown" class="dropdown d-none">
                        <div class="list-group shadow" style="position: absolute; z-index: 1000; max-height: 250px; overflow-y: auto; min-width: 400px;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left: Calendar -->
        <div class="col-lg-7">
            <div class="card">
                <!-- Calendar Header -->
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeMonth(-1)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <div>
                        <h5 class="mb-0 d-inline" id="calendarMonthTitle">@Model.StartDate.ToString("MMMM yyyy")</h5>
                        <button class="btn btn-sm btn-link" onclick="goToToday()">Today</button>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeMonth(1)">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                </div>
                
                <div class="card-body p-2">
                    <!-- Instruction -->
                    <div class="alert alert-info py-2 mb-2 small">
                        <i class="bi bi-info-circle me-1"></i>
                        Select an enhancement above, then <strong>click</strong> a day to view/edit entries. 
                        <strong>Shift+Click</strong> to select a range for bulk entry.
                    </div>

                    <!-- Calendar Grid -->
                    <div id="calendarGrid">
                        @await Html.PartialAsync("_CalendarGrid", Model)
                    </div>
                </div>
                
                <!-- Calendar Footer -->
                <div class="card-footer py-2">
                    <div class="row align-items-center small">
                        <div class="col">
                            <span class="text-success me-3"><i class="bi bi-circle-fill"></i> Has entries</span>
                            <span class="text-primary me-3"><i class="bi bi-square-fill"></i> Selected</span>
                            <span class="text-warning"><i class="bi bi-square"></i> Today</span>
                        </div>
                        <div class="col-auto">
                            <strong id="enhancementMonthTotal">Select an enhancement</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Summary -->
            <div class="card mt-3" id="monthlySummaryCard" style="display: none;">
                <div class="card-header py-2">
                    <i class="bi bi-bar-chart me-1"></i> <span id="summaryTitle">Monthly Summary</span>
                </div>
                <div class="card-body py-2">
                    <div class="row text-center">
                        <div class="col">
                            <div class="h4 mb-0 text-primary" id="summaryTotalHours">0</div>
                            <small class="text-muted">Total Hours</small>
                        </div>
                        <div class="col">
                            <div class="h4 mb-0 text-success" id="summaryContributedHours">0</div>
                            <small class="text-muted">Contributed</small>
                        </div>
                        <div class="col">
                            <div class="h4 mb-0" id="summaryDaysWorked">0</div>
                            <small class="text-muted">Days Worked</small>
                        </div>
                        <div class="col border-start">
                            <div class="h6 mb-1">By Work Type</div>
                            <small id="summaryByWorkType">-</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Entry Panel -->
        <div class="col-lg-5">
            <!-- Placeholder when no enhancement selected -->
            <div id="noEnhancementPanel" class="card">
                <div class="card-body text-center py-5 text-muted">
                    <i class="bi bi-arrow-left-circle display-4"></i>
                    <p class="mt-3">Select a service area and enhancement to start logging time.</p>
                </div>
            </div>

            <!-- Single Day Panel -->
            <div id="singleDayPanel" class="card" style="display: none;">
                <div class="card-header bg-primary text-white py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span>
                            <i class="bi bi-calendar-day me-1"></i>
                            <strong id="singleDayTitle">Select a date</strong>
                        </span>
                        <button class="btn btn-sm btn-light" onclick="showAddEntryForm()">
                            <i class="bi bi-plus-lg"></i> Add Entry
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="dayEntriesLoading" class="text-center py-3" style="display: none;">
                        <div class="spinner-border spinner-border-sm"></div> Loading...
                    </div>
                    <div id="dayEntriesEmpty" class="text-center py-4 text-muted" style="display: none;">
                        <i class="bi bi-inbox"></i> No entries for this day.
                    </div>
                    <table class="table table-sm table-hover mb-0" id="dayEntriesTable" style="display: none;">
                        <thead class="table-light">
                            <tr>
                                <th>Work Type</th>
                                <th class="text-center" style="width: 60px;">Hours</th>
                                <th class="text-center" style="width: 60px;">Contrib.</th>
                                <th style="width: 70px;"></th>
                            </tr>
                        </thead>
                        <tbody id="dayEntriesBody">
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th class="text-end">Day Total:</th>
                                <th class="text-center" id="dayTotalHours">0</th>
                                <th class="text-center" id="dayTotalContributed">0</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- Inline Add Form -->
                <div id="addEntryForm" class="card-footer bg-light" style="display: none;">
                    <h6 class="mb-2"><i class="bi bi-plus-circle me-1"></i> Add New Entry</h6>
                    <div class="row g-2">
                        <div class="col-md-5">
                            <select id="newEntryWorkPhase" class="form-select form-select-sm">
                                <option value="">Select Work Type</option>
                                @foreach (var wp in Model.WorkPhases)
                                {
                                    <option value="@wp.Id" data-contribution="@wp.DefaultContributionPercent">@wp.Name</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="number" id="newEntryHours" class="form-control form-control-sm" 
                                   placeholder="Hrs" step="0.25" min="0.25" onchange="updateNewEntryContributed()">
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="newEntryNotes" class="form-control form-control-sm" placeholder="Notes...">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-sm btn-success w-100" onclick="saveNewEntry()">
                                <i class="bi bi-check"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Range Selection Panel -->
            <div id="rangeDayPanel" class="card" style="display: none;">
                <div class="card-header bg-warning">
                    <i class="bi bi-calendar-range me-1"></i>
                    <strong id="rangeDayTitle">Bulk Entry</strong>
                    <span class="badge bg-dark float-end" id="rangeDayCount">0 days</span>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning py-2 mb-3 small">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Entries will be created for <strong>each day</strong> in the selected range.
                    </div>

                    <table class="table table-sm table-bordered mb-3" id="bulkEntriesTable">
                        <thead class="table-light">
                            <tr>
                                <th>Work Type</th>
                                <th style="width: 90px;">Hours/Day</th>
                                <th style="width: 40px;"></th>
                            </tr>
                        </thead>
                        <tbody id="bulkEntriesBody">
                        </tbody>
                    </table>
                    
                    <button class="btn btn-sm btn-outline-primary mb-3" onclick="addBulkEntryRow()">
                        <i class="bi bi-plus"></i> Add Work Type
                    </button>

                    <div class="alert alert-info py-2 mb-3" id="bulkPreview">
                        <strong>Preview:</strong> <span id="bulkPreviewText">0 days × 0 hrs/day = 0 hours total</span>
                    </div>

                    <div class="d-flex gap-2">
                        <button class="btn btn-secondary flex-grow-1" onclick="cancelBulkEntry()">
                            <i class="bi bi-x-lg me-1"></i> Cancel
                        </button>
                        <button class="btn btn-success flex-grow-1" onclick="saveBulkEntries()" id="saveBulkBtn">
                            <i class="bi bi-check-lg me-1"></i> Create Entries
                        </button>
                    </div>
                </div>
            </div>

            <!-- My Overview -->
            <div class="card mt-3">
                <div class="card-header py-2">
                    <i class="bi bi-graph-up me-1"></i> My <span id="overviewMonthName">@Model.StartDate.ToString("MMMM")</span> Overview
                </div>
                <div class="card-body py-2">
                    <div id="overviewLoading" class="text-center py-2">
                        <div class="spinner-border spinner-border-sm"></div>
                    </div>
                    <table class="table table-sm mb-0" id="overviewTable" style="display: none;">
                        <tbody id="overviewBody">
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td><strong>Total</strong></td>
                                <td class="text-end"><strong id="overviewTotal">0h</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Entry Modal -->
<div class="modal fade" id="editEntryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editEntryId">
                <div class="mb-3">
                    <label class="form-label">Work Type</label>
                    <select id="editWorkPhase" class="form-select">
                        @foreach (var wp in Model.WorkPhases)
                        {
                            <option value="@wp.Id" data-contribution="@wp.DefaultContributionPercent">@wp.Name</option>
                        }
                    </select>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <label class="form-label">Hours</label>
                        <input type="number" id="editHours" class="form-control" step="0.25" min="0.25">
                    </div>
                    <div class="col">
                        <label class="form-label">Contributed</label>
                        <input type="number" id="editContributed" class="form-control" step="0.25" min="0">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea id="editNotes" class="form-control" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateEntry()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // State
    let selectedEnhancement = null;
    let selectedDate = null;
    let selectedDateRange = [];
    let currentMonth = new Date(@Model.StartDate.Year, @(Model.StartDate.Month - 1), 1);
    let calendarData = {}; // { 'YYYY-MM-DD': { hours: X, contributed: Y, entries: [] } }
    let searchTimeout = null;
    let workPhases = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.WorkPhases.Select(wp => new { wp.Id, wp.Name, wp.DefaultContributionPercent })));
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadOverview();
    });

    // Enhancement Search
    function debounceEnhancementSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(searchEnhancements, 300);
    }

    function searchEnhancements() {
        const serviceAreaId = document.getElementById('serviceAreaFilter').value;
        const search = document.getElementById('enhancementSearch').value;
        
        if (!search && !serviceAreaId) {
            hideEnhancementDropdown();
            return;
        }

        let url = '/timesheet/enhancements?';
        if (serviceAreaId) url += 'serviceAreaId=' + encodeURIComponent(serviceAreaId) + '&';
        if (search) url += 'workIdSearch=' + encodeURIComponent(search) + '&descriptionSearch=' + encodeURIComponent(search);

        fetch(url)
            .then(r => r.json())
            .then(data => {
                showEnhancementDropdown(data);
            });
    }

    function showEnhancementDropdown(enhancements) {
        const dropdown = document.getElementById('enhancementDropdown');
        const list = dropdown.querySelector('.list-group');
        
        if (enhancements.length === 0) {
            list.innerHTML = '<div class="list-group-item text-muted">No enhancements found</div>';
        } else {
            list.innerHTML = enhancements.slice(0, 10).map(e => `
                <a href="#" class="list-group-item list-group-item-action py-2" onclick="selectEnhancement('${e.id}', '${e.workId}', '${(e.description || '').replace(/'/g, "\\'")}'); return false;">
                    <strong>${e.workId}</strong> - ${e.description || ''}<br>
                    <small class="text-muted">${e.serviceAreaCode || ''} | ${e.status || ''}</small>
                </a>
            `).join('');
        }
        
        dropdown.classList.remove('d-none');
    }

    function hideEnhancementDropdown() {
        document.getElementById('enhancementDropdown').classList.add('d-none');
    }

    function selectEnhancement(id, workId, description) {
        selectedEnhancement = { id, workId, description };
        
        document.getElementById('selectedWorkId').textContent = workId;
        document.getElementById('selectedDescription').textContent = description;
        document.getElementById('selectedEnhancementDisplay').classList.remove('d-none');
        document.getElementById('enhancementSearch').value = '';
        hideEnhancementDropdown();
        
        // Show panels
        document.getElementById('noEnhancementPanel').style.display = 'none';
        document.getElementById('monthlySummaryCard').style.display = 'block';
        
        // Load calendar data for this enhancement
        loadCalendarData();
    }

    function clearEnhancement() {
        selectedEnhancement = null;
        selectedDate = null;
        selectedDateRange = [];
        
        document.getElementById('selectedEnhancementDisplay').classList.add('d-none');
        document.getElementById('noEnhancementPanel').style.display = 'block';
        document.getElementById('singleDayPanel').style.display = 'none';
        document.getElementById('rangeDayPanel').style.display = 'none';
        document.getElementById('monthlySummaryCard').style.display = 'none';
        document.getElementById('enhancementMonthTotal').textContent = 'Select an enhancement';
        
        // Clear calendar highlights
        document.querySelectorAll('.calendar-day').forEach(d => {
            d.classList.remove('has-hours', 'selected', 'range-selected');
            const badge = d.querySelector('.hours-badge');
            if (badge) badge.remove();
        });
    }

    function onServiceAreaChange() {
        clearEnhancement();
        searchEnhancements();
    }

    // Calendar Navigation
    function changeMonth(delta) {
        currentMonth.setMonth(currentMonth.getMonth() + delta);
        loadCalendarGrid();
        if (selectedEnhancement) {
            loadCalendarData();
        }
        loadOverview();
    }

    function goToToday() {
        currentMonth = new Date();
        currentMonth.setDate(1);
        loadCalendarGrid();
        if (selectedEnhancement) {
            loadCalendarData();
        }
        loadOverview();
    }

    function loadCalendarGrid() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth() + 1;
        
        fetch(`/timesheet/calendar-grid?year=${year}&month=${month}`)
            .then(r => r.text())
            .then(html => {
                document.getElementById('calendarGrid').innerHTML = html;
                document.getElementById('calendarMonthTitle').textContent = 
                    currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                document.getElementById('overviewMonthName').textContent = 
                    currentMonth.toLocaleDateString('en-US', { month: 'long' });
                
                if (selectedEnhancement) {
                    applyCalendarData();
                }
            });
    }

    function loadCalendarData() {
        if (!selectedEnhancement) return;
        
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth() + 1;
        
        fetch(`/timesheet/calendar-data?enhancementId=${selectedEnhancement.id}&year=${year}&month=${month}`)
            .then(r => r.json())
            .then(data => {
                calendarData = data.dayData || {};
                applyCalendarData();
                updateMonthlySummary(data.summary);
            });
    }

    function applyCalendarData() {
        // Clear existing
        document.querySelectorAll('.calendar-day').forEach(d => {
            d.classList.remove('has-hours');
            const badge = d.querySelector('.hours-badge');
            if (badge) badge.remove();
        });
        
        // Apply data
        let totalHours = 0;
        for (const [dateStr, dayInfo] of Object.entries(calendarData)) {
            const dayEl = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
            if (dayEl && dayInfo.hours > 0) {
                dayEl.classList.add('has-hours');
                const badge = document.createElement('span');
                badge.className = 'hours-badge';
                badge.textContent = dayInfo.hours + 'h';
                dayEl.appendChild(badge);
                totalHours += dayInfo.hours;
            }
        }
        
        document.getElementById('enhancementMonthTotal').innerHTML = 
            `<strong>${selectedEnhancement.workId}</strong> Total: ${totalHours}h`;
    }

    function updateMonthlySummary(summary) {
        if (!summary) return;
        
        document.getElementById('summaryTitle').textContent = 
            `${currentMonth.toLocaleDateString('en-US', { month: 'long' })} Summary for ${selectedEnhancement.workId}`;
        document.getElementById('summaryTotalHours').textContent = summary.totalHours || 0;
        document.getElementById('summaryContributedHours').textContent = summary.contributedHours || 0;
        document.getElementById('summaryDaysWorked').textContent = summary.daysWorked || 0;
        
        if (summary.byWorkType && Object.keys(summary.byWorkType).length > 0) {
            document.getElementById('summaryByWorkType').textContent = 
                Object.entries(summary.byWorkType).map(([k, v]) => `${k}: ${v}h`).join(' | ');
        } else {
            document.getElementById('summaryByWorkType').textContent = '-';
        }
    }

    // Day Selection
    let lastClickedDate = null;
    
    function onDayClick(dateStr, event) {
        if (!selectedEnhancement) {
            alert('Please select an enhancement first.');
            return;
        }
        
        const clickedDate = new Date(dateStr);
        
        if (event.shiftKey && lastClickedDate) {
            // Range selection
            selectDateRange(lastClickedDate, dateStr);
        } else {
            // Single selection
            lastClickedDate = dateStr;
            selectSingleDate(dateStr);
        }
    }

    function selectSingleDate(dateStr) {
        selectedDate = dateStr;
        selectedDateRange = [];
        
        // Update UI
        document.querySelectorAll('.calendar-day').forEach(d => {
            d.classList.remove('selected', 'range-selected');
        });
        const dayEl = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
        if (dayEl) dayEl.classList.add('selected');
        
        // Show single day panel
        document.getElementById('singleDayPanel').style.display = 'block';
        document.getElementById('rangeDayPanel').style.display = 'none';
        
        const date = new Date(dateStr);
        document.getElementById('singleDayTitle').textContent = 
            date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
        
        loadDayEntries(dateStr);
    }

    function selectDateRange(startStr, endStr) {
        const start = new Date(startStr);
        const end = new Date(endStr);
        
        if (start > end) {
            [startStr, endStr] = [endStr, startStr];
        }
        
        selectedDate = null;
        selectedDateRange = [];
        
        // Build range
        let current = new Date(Math.min(start, end));
        const endDate = new Date(Math.max(start, end));
        while (current <= endDate) {
            selectedDateRange.push(current.toISOString().split('T')[0]);
            current.setDate(current.getDate() + 1);
        }
        
        // Update UI
        document.querySelectorAll('.calendar-day').forEach(d => {
            d.classList.remove('selected', 'range-selected');
            if (selectedDateRange.includes(d.dataset.date)) {
                d.classList.add('range-selected');
            }
        });
        
        // Show range panel
        document.getElementById('singleDayPanel').style.display = 'none';
        document.getElementById('rangeDayPanel').style.display = 'block';
        
        const startDate = new Date(selectedDateRange[0]);
        const endDateObj = new Date(selectedDateRange[selectedDateRange.length - 1]);
        document.getElementById('rangeDayTitle').textContent = 
            `Bulk Entry: ${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
        document.getElementById('rangeDayCount').textContent = selectedDateRange.length + ' days';
        
        // Initialize bulk entry form
        initBulkEntryForm();
    }

    // Day Entries
    function loadDayEntries(dateStr) {
        if (!selectedEnhancement) return;
        
        document.getElementById('dayEntriesLoading').style.display = 'block';
        document.getElementById('dayEntriesTable').style.display = 'none';
        document.getElementById('dayEntriesEmpty').style.display = 'none';
        document.getElementById('addEntryForm').style.display = 'none';
        
        fetch(`/timesheet/day-entries?enhancementId=${selectedEnhancement.id}&date=${dateStr}`)
            .then(r => r.json())
            .then(entries => {
                document.getElementById('dayEntriesLoading').style.display = 'none';
                
                if (entries.length === 0) {
                    document.getElementById('dayEntriesEmpty').style.display = 'block';
                } else {
                    renderDayEntries(entries);
                    document.getElementById('dayEntriesTable').style.display = 'table';
                }
            });
    }

    function renderDayEntries(entries) {
        const tbody = document.getElementById('dayEntriesBody');
        let totalHours = 0;
        let totalContributed = 0;
        
        tbody.innerHTML = entries.map(e => {
            totalHours += e.hours;
            totalContributed += e.contributedHours;
            const isLocked = e.isConsolidated;
            return `
                <tr>
                    <td>
                        <strong>${e.workPhaseName}</strong>
                        ${e.notes ? `<br><small class="text-muted">${e.notes}</small>` : ''}
                    </td>
                    <td class="text-center">${e.hours.toFixed(1)}</td>
                    <td class="text-center">${e.contributedHours.toFixed(1)}</td>
                    <td>
                        ${isLocked ? '<i class="bi bi-lock text-warning" title="Consolidated"></i>' : `
                            <button class="btn btn-sm btn-outline-primary" onclick="editEntry('${e.id}', '${e.workPhaseId}', ${e.hours}, ${e.contributedHours}, '${(e.notes || '').replace(/'/g, "\\'")}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteEntry('${e.id}')"><i class="bi bi-trash"></i></button>
                        `}
                    </td>
                </tr>
            `;
        }).join('');
        
        document.getElementById('dayTotalHours').textContent = totalHours.toFixed(1);
        document.getElementById('dayTotalContributed').textContent = totalContributed.toFixed(1);
    }

    function showAddEntryForm() {
        document.getElementById('addEntryForm').style.display = 'block';
        document.getElementById('newEntryWorkPhase').value = '';
        document.getElementById('newEntryHours').value = '';
        document.getElementById('newEntryNotes').value = '';
    }

    function updateNewEntryContributed() {
        const wpSelect = document.getElementById('newEntryWorkPhase');
        const hours = parseFloat(document.getElementById('newEntryHours').value) || 0;
        const contribution = parseInt(wpSelect.options[wpSelect.selectedIndex]?.dataset?.contribution) || 100;
        // Contributed hours calculated server-side based on work phase
    }

    function saveNewEntry() {
        const workPhaseId = document.getElementById('newEntryWorkPhase').value;
        const hours = document.getElementById('newEntryHours').value;
        const notes = document.getElementById('newEntryNotes').value;
        
        if (!workPhaseId || !hours) {
            alert('Please select work type and enter hours.');
            return;
        }
        
        const formData = new URLSearchParams();
        formData.append('EnhancementId', selectedEnhancement.id);
        formData.append('WorkPhaseId', workPhaseId);
        formData.append('StartDate', selectedDate);
        formData.append('EndDate', selectedDate);
        formData.append('Hours', hours);
        formData.append('Notes', notes);
        formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
        
        fetch('/timesheet/entry/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                loadDayEntries(selectedDate);
                loadCalendarData();
                loadOverview();
                document.getElementById('addEntryForm').style.display = 'none';
            } else {
                alert(result.message || 'Error saving entry');
            }
        });
    }

    function editEntry(id, workPhaseId, hours, contributed, notes) {
        document.getElementById('editEntryId').value = id;
        document.getElementById('editWorkPhase').value = workPhaseId;
        document.getElementById('editHours').value = hours;
        document.getElementById('editContributed').value = contributed;
        document.getElementById('editNotes').value = notes;
        
        new bootstrap.Modal(document.getElementById('editEntryModal')).show();
    }

    function updateEntry() {
        const id = document.getElementById('editEntryId').value;
        const formData = new URLSearchParams();
        formData.append('Id', id);
        formData.append('EnhancementId', selectedEnhancement.id);
        formData.append('WorkPhaseId', document.getElementById('editWorkPhase').value);
        formData.append('StartDate', selectedDate);
        formData.append('EndDate', selectedDate);
        formData.append('Hours', document.getElementById('editHours').value);
        formData.append('ContributedHours', document.getElementById('editContributed').value);
        formData.append('Notes', document.getElementById('editNotes').value);
        formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
        
        fetch('/timesheet/entry/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                bootstrap.Modal.getInstance(document.getElementById('editEntryModal')).hide();
                loadDayEntries(selectedDate);
                loadCalendarData();
                loadOverview();
            } else {
                alert(result.message || 'Error updating entry');
            }
        });
    }

    function deleteEntry(id) {
        if (!confirm('Delete this entry?')) return;
        
        const formData = new URLSearchParams();
        formData.append('id', id);
        formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);
        
        fetch('/timesheet/entry/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData.toString()
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                loadDayEntries(selectedDate);
                loadCalendarData();
                loadOverview();
            } else {
                alert(result.message || 'Error deleting entry');
            }
        });
    }

    // Bulk Entry
    let bulkRowCounter = 0;
    
    function initBulkEntryForm() {
        document.getElementById('bulkEntriesBody').innerHTML = '';
        bulkRowCounter = 0;
        addBulkEntryRow();
        updateBulkPreview();
    }

    function addBulkEntryRow() {
        const rowId = 'bulk_' + (++bulkRowCounter);
        const options = workPhases.map(wp => 
            `<option value="${wp.id}" data-contribution="${wp.defaultContributionPercent}">${wp.name}</option>`
        ).join('');
        
        const row = document.createElement('tr');
        row.id = rowId;
        row.innerHTML = `
            <td>
                <select class="form-select form-select-sm bulk-workphase" onchange="updateBulkPreview()">
                    <option value="">Select...</option>
                    ${options}
                </select>
            </td>
            <td>
                <input type="number" class="form-control form-control-sm bulk-hours" 
                       step="0.5" min="0.5" placeholder="0" onchange="updateBulkPreview()">
            </td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="removeBulkRow('${rowId}')">
                    <i class="bi bi-x"></i>
                </button>
            </td>
        `;
        
        document.getElementById('bulkEntriesBody').appendChild(row);
    }

    function removeBulkRow(rowId) {
        document.getElementById(rowId)?.remove();
        updateBulkPreview();
    }

    function updateBulkPreview() {
        let totalHoursPerDay = 0;
        document.querySelectorAll('#bulkEntriesBody tr').forEach(row => {
            const hours = parseFloat(row.querySelector('.bulk-hours')?.value) || 0;
            totalHoursPerDay += hours;
        });
        
        const days = selectedDateRange.length;
        const total = days * totalHoursPerDay;
        
        document.getElementById('bulkPreviewText').textContent = 
            `${days} days × ${totalHoursPerDay} hrs/day = ${total} hours total`;
        document.getElementById('saveBulkBtn').textContent = 
            `Create ${days * document.querySelectorAll('#bulkEntriesBody tr').length} Entries`;
    }

    function cancelBulkEntry() {
        selectedDateRange = [];
        document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('range-selected'));
        document.getElementById('rangeDayPanel').style.display = 'none';
    }

    async function saveBulkEntries() {
        const entries = [];
        document.querySelectorAll('#bulkEntriesBody tr').forEach(row => {
            const workPhaseId = row.querySelector('.bulk-workphase')?.value;
            const hours = parseFloat(row.querySelector('.bulk-hours')?.value) || 0;
            if (workPhaseId && hours > 0) {
                entries.push({ workPhaseId, hours });
            }
        });
        
        if (entries.length === 0) {
            alert('Please add at least one valid entry.');
            return;
        }
        
        const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
        let successCount = 0;
        
        document.getElementById('saveBulkBtn').disabled = true;
        document.getElementById('saveBulkBtn').innerHTML = '<i class="bi bi-hourglass"></i> Saving...';
        
        for (const dateStr of selectedDateRange) {
            for (const entry of entries) {
                const formData = new URLSearchParams();
                formData.append('EnhancementId', selectedEnhancement.id);
                formData.append('WorkPhaseId', entry.workPhaseId);
                formData.append('StartDate', dateStr);
                formData.append('EndDate', dateStr);
                formData.append('Hours', entry.hours);
                formData.append('__RequestVerificationToken', token);
                
                try {
                    const response = await fetch('/timesheet/entry/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData.toString()
                    });
                    const result = await response.json();
                    if (result.success) successCount++;
                } catch (e) {
                    console.error(e);
                }
            }
        }
        
        alert(`Created ${successCount} entries.`);
        cancelBulkEntry();
        loadCalendarData();
        loadOverview();
        
        document.getElementById('saveBulkBtn').disabled = false;
        document.getElementById('saveBulkBtn').innerHTML = '<i class="bi bi-check-lg me-1"></i> Create Entries';
    }

    // Overview
    function loadOverview() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth() + 1;
        
        document.getElementById('overviewLoading').style.display = 'block';
        document.getElementById('overviewTable').style.display = 'none';
        
        fetch(`/timesheet/month-overview?year=${year}&month=${month}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('overviewLoading').style.display = 'none';
                document.getElementById('overviewTable').style.display = 'table';
                
                const tbody = document.getElementById('overviewBody');
                if (data.enhancements && data.enhancements.length > 0) {
                    tbody.innerHTML = data.enhancements.map(e => `
                        <tr>
                            <td>
                                <span class="badge ${e.id === selectedEnhancement?.id ? 'bg-primary' : 'bg-secondary'}">${e.workId}</span>
                                ${e.description ? e.description.substring(0, 30) : ''}
                            </td>
                            <td class="text-end"><strong>${e.hours}h</strong></td>
                        </tr>
                    `).join('');
                    document.getElementById('overviewTotal').textContent = data.totalHours + 'h';
                } else {
                    tbody.innerHTML = '<tr><td colspan="2" class="text-muted text-center">No entries this month</td></tr>';
                    document.getElementById('overviewTotal').textContent = '0h';
                }
                
                document.getElementById('monthTotalBadge').textContent = 
                    `${currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}: ${data.totalHours || 0} hrs`;
            });
    }

    // Click outside to close dropdown
    document.addEventListener('click', function(e) {
        if (!e.target.closest('#enhancementSearch') && !e.target.closest('#enhancementDropdown')) {
            hideEnhancementDropdown();
        }
    });
</script>
@Html.AntiForgeryToken()
}

<style>
    .calendar-day {
        height: 65px;
        border: 1px solid #dee2e6;
        cursor: pointer;
        transition: all 0.15s;
        position: relative;
        font-size: 0.85rem;
    }
    .calendar-day:hover {
        background-color: #e7f1ff;
        border-color: #0d6efd;
    }
    .calendar-day.selected {
        background-color: #cfe2ff;
        border: 2px solid #0d6efd;
    }
    .calendar-day.range-selected {
        background-color: #fff3cd;
        border: 2px dashed #ffc107;
    }
    .calendar-day .day-number {
        font-weight: bold;
    }
    .calendar-day .hours-badge {
        position: absolute;
        bottom: 2px;
        right: 4px;
        font-size: 0.75rem;
        font-weight: bold;
        color: #198754;
    }
    .calendar-day.has-hours {
        background-color: #d1e7dd;
    }
    .calendar-day.has-hours:hover {
        background-color: #badbcc;
    }
    .calendar-day.other-month {
        background-color: #f8f9fa;
        color: #adb5bd;
    }
    .calendar-day.today {
        border: 2px solid #ffc107;
    }
    .calendar-day.weekend {
        background-color: #fafafa;
    }
    .calendar-header {
        background-color: #f8f9fa;
        font-weight: bold;
        text-align: center;
        padding: 6px;
        border: 1px solid #dee2e6;
        font-size: 0.8rem;
    }
</style>
