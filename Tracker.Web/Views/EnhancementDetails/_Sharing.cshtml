@model SharingViewModel

<div class="mb-4">
    <h6 class="mb-3"><i class="bi bi-share me-1"></i> Share to Another Service Area</h6>
    
    <p class="text-muted">
        Create a copy of this work item (<strong>@Model.WorkId</strong>) in another service area. 
        The copy will include all notes and a sharing record indicating the source.
    </p>

    @if (Model.ExistingServiceAreaNames.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-1"></i>
            <strong>@Model.WorkId</strong> already exists in: 
            <span class="fw-bold">@string.Join(", ", Model.ExistingServiceAreaNames)</span>
        </div>
    }

    @if (!Model.AvailableTargetServiceAreas.Any())
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-1"></i>
            No additional service areas available for sharing. This work item either exists in all your accessible service areas, or you don't have access to other areas.
        </div>
    }
    else
    {
        <form id="shareForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="EnhancementId" value="@Model.EnhancementId" />
            
            <div class="mb-3">
                <label class="form-label">Target Service Area</label>
                <select name="TargetServiceAreaId" id="targetServiceArea" class="form-select" required>
                    <option value="">-- Select Service Area --</option>
                    @foreach (var sa in Model.AvailableTargetServiceAreas)
                    {
                        <option value="@sa.Id">@sa.Name</option>
                    }
                </select>
            </div>
            
            <div class="alert alert-secondary small">
                <strong>What will be copied:</strong>
                <ul class="mb-0 mt-1">
                    <li>Work ID, Description, Notes (quick notes field)</li>
                    <li>Estimation details (hours, dates, estimation notes)</li>
                    <li>All notes from the Notes History tab</li>
                    <li>A sharing record indicating who shared and when</li>
                </ul>
                <strong class="mt-2 d-block">What will NOT be copied:</strong>
                <ul class="mb-0 mt-1">
                    <li>Assigned resources (will need to be re-assigned)</li>
                    <li>Actual hours/dates (will be blank)</li>
                    <li>Attachments (remain with original)</li>
                    <li>Time recording entries (remain with original)</li>
                </ul>
            </div>
            
            <button type="submit" class="btn btn-primary" id="shareBtn">
                <i class="bi bi-share me-1"></i> Create Copy
            </button>
        </form>
    }
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="shareConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Share</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Create a copy of <strong>@Model.WorkId</strong> in <strong id="targetServiceAreaName"></strong>?</p>
                <p class="text-muted small">The copy will be created with status "New" and you will be redirected to the new work item.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmShareBtn">
                    <i class="bi bi-share me-1"></i> Create Copy
                </button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var shareForm = document.getElementById('shareForm');
    if (!shareForm) return;
    
    var targetSelect = document.getElementById('targetServiceArea');
    var confirmModal = null;
    
    shareForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        if (!targetSelect.value) {
            alert('Please select a target service area.');
            return;
        }
        
        // Show selected name in modal
        var selectedText = targetSelect.options[targetSelect.selectedIndex].text;
        document.getElementById('targetServiceAreaName').textContent = selectedText;
        
        confirmModal = new bootstrap.Modal(document.getElementById('shareConfirmModal'));
        confirmModal.show();
    });
    
    document.getElementById('confirmShareBtn').addEventListener('click', function() {
        var btn = this;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Creating...';
        
        var data = {
            enhancementId: '@Model.EnhancementId',
            targetServiceAreaId: targetSelect.value
        };
        
        fetch('@Url.Action("Share", "Enhancements")', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'RequestVerificationToken': antiForgeryToken 
            },
            body: JSON.stringify(data)
        })
        .then(function(r) { return r.json(); })
        .then(function(result) {
            if (result.success) {
                // Redirect to the new enhancement
                window.location.href = '@Url.Action("Details", "Enhancements")/' + result.newEnhancementId + 
                    '?serviceAreaId=' + result.serviceAreaId;
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-share me-1"></i> Create Copy';
                alert(result.message || 'Share failed');
                if (confirmModal) confirmModal.hide();
            }
        })
        .catch(function(err) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-share me-1"></i> Create Copy';
            alert('Error: ' + err.message);
            if (confirmModal) confirmModal.hide();
        });
    });
})();
</script>
