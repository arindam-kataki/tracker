@model TicketDetailsViewModel
@{
    var isNew = string.IsNullOrEmpty(Model.Id);
    Model.AvailableTimeCategories = new List<TimeRecordingCategory>();
}

@* Custom styles for better readability *@
<style>
    /* Larger, bolder form labels */
    .form-label {
        font-size: 0.95rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.4rem;
    }

    /* Darker control borders */
    .form-control,
    .form-select {
        border-color: #6b7280;
        border-width: 1.5px;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.25);
    }

    /* Slightly larger input text */
    .form-control,
    .form-select {
        font-size: 0.95rem;
    }

    /* Section header styling */
    .section-header {
        font-size: 1.1rem;
    }
</style>

<form id="ticketDetailsForm">
    @Html.AntiForgeryToken()
    <input type="hidden" name="Id" value="@Model.Id" />
    <input type="hidden" name="ServiceAreaId" value="@Model.ServiceAreaId" />

    <div class="row g-3">

        <!-- ============================================ -->
        <!-- SECTION: Core Information -->
        <!-- ============================================ -->
        <div class="col-12">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                    style="width: 28px; height: 28px;">
                    <i class="bi bi-info-circle"></i>
                </div>
                <h5 class="mb-0 text-primary fw-bold">Core Information</h5>
            </div>
            <hr class="mt-0 mb-3" style="border-top: 2px solid var(--bs-primary); opacity: 0.5;" />
        </div>

        <!-- Row 1: Work ID and Status -->
        <div class="col-md-6">
            <label class="form-label">Work ID <span class="text-danger">*</span></label>
            <input type="text" name="WorkId" value="@Model.WorkId" class="form-control" required />
        </div>

        <div class="col-md-6">
            <label class="form-label">Status</label>
            <select name="Status" class="form-select">
                <option value="">-- Select --</option>
                @foreach (var s in Model.AvailableInfStatuses)
                {
                    <option value="@s" selected="@(Model.Status == s)">@s</option>
                }
            </select>
        </div>

        <!-- Row 2: Description -->
        <div class="col-12">
            <label class="form-label">Description</label>
            <input type="text" name="Description" value="@Model.Description" class="form-control" />
        </div>

        <!-- Row 3: Notes -->
        <div class="col-12">
            <label class="form-label">Notes</label>
            <textarea name="Notes" class="form-control" rows="2">@Model.Notes</textarea>
        </div>

        <!-- ============================================ -->
        <!-- SECTION: Sizing (L3H/Estimation) -->
        <!-- ============================================ -->
        <div class="col-12 mt-4">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                    style="width: 28px; height: 28px;">
                    <i class="bi bi-calculator"></i>
                </div>
                <h5 class="mb-0 text-success fw-bold">Sizing</h5>
            </div>
            <hr class="mt-0 mb-3" style="border-top: 2px solid var(--bs-success); opacity: 0.5;" />
        </div>

        <!-- Sizing Row 1: Hours, Start Date, End Date -->
        <div class="col-md-4">
            <label class="form-label">Est. Hours</label>
            <input type="number" name="EstimatedHours" value="@Model.EstimatedHours" class="form-control" step="0.5" />
        </div>

        <div class="col-md-4">
            <label class="form-label">Est. Start Date</label>
            <input type="date" name="EstimatedStartDate" value="@Model.EstimatedStartDate?.ToString("yyyy-MM-dd")"
                class="form-control" />
        </div>

        <div class="col-md-4">
            <label class="form-label">Est. End Date</label>
            <input type="date" name="EstimatedEndDate" value="@Model.EstimatedEndDate?.ToString("yyyy-MM-dd")"
                class="form-control" />
        </div>

        <!-- Sizing Row 2: Status, Labor Type, Priority -->
        <div class="col-md-4">
            <label class="form-label">Sizing Status</label>
            <select name="EstimatedStatus" class="form-select">
                <option value="">-- Select --</option>
                @foreach (var s in Model.AvailableSizingStatuses)
                {
                    <option value="@s" selected="@(Model.EstimatedStatus == s)">@s</option>
                }
            </select>
        </div>

        <div class="col-md-4">
            <label class="form-label">Labor Type</label>
            <select name="EstimatedLaborType" class="form-select">
                <option value="">-- Select --</option>
                @foreach (var lt in Model.AvailableLaborTypes)
                {
                    <option value="@lt" selected="@(Model.EstimatedLaborType == lt)">@lt</option>
                }
            </select>
        </div>

        <div class="col-md-4">
            <label class="form-label">Priority</label>
            <select name="EstimatedPriority" class="form-select">
                <option value="">-- Select --</option>
                @foreach (var p in Model.AvailablePriorities)
                {
                    <option value="@p" selected="@(Model.EstimatedPriority == p)">@p</option>
                }
            </select>
        </div>

        <!-- Sizing Row 3: Notes -->
        <div class="col-12">
            <label class="form-label">Sizing Notes</label>
            <textarea name="EstimationNotes" class="form-control" rows="2">@Model.EstimationNotes</textarea>
        </div>

        <!-- ============================================ -->
        <!-- SECTION: Approved -->
        <!-- ============================================ -->
        <div class="col-12 mt-4">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                    style="width: 28px; height: 28px;">
                    <i class="bi bi-check2-circle"></i>
                </div>
                <h5 class="mb-0 text-info fw-bold">Approved</h5>
            </div>
            <hr class="mt-0 mb-3" style="border-top: 2px solid var(--bs-info); opacity: 0.5;" />
        </div>

        <!-- Approved Row 1: Hours, Start Date, End Date -->
        <div class="col-md-4">
            <label class="form-label">Hours</label>
            <input type="number" name="ReturnedHours" value="@Model.ReturnedHours" class="form-control" step="0.5" />
        </div>

        <div class="col-md-4">
            <label class="form-label">Start Date</label>
            <input type="date" name="StartDate" value="@Model.StartDate?.ToString("yyyy-MM-dd")" class="form-control" />
        </div>

        <div class="col-md-4">
            <label class="form-label">End Date</label>
            <input type="date" name="EndDate" value="@Model.EndDate?.ToString("yyyy-MM-dd")" class="form-control" />
        </div>

        <!-- Approved Row 2: Labor Type, Priority -->
        <div class="col-md-6">
            <label class="form-label">Labor Type</label>
            <select name="InfLaborType" class="form-select">
                <option value="">-- Select --</option>
                @foreach (var lt in Model.AvailableLaborTypes)
                {
                    <option value="@lt" selected="@(Model.InfLaborType == lt)">@lt</option>
                }
            </select>
        </div>

        <div class="col-md-6">
            <label class="form-label">Priority</label>
            <select name="InfPriority" class="form-select">
                <option value="">-- Select --</option>
                @foreach (var p in Model.AvailablePriorities)
                {
                    <option value="@p" selected="@(Model.InfPriority == p)">@p</option>
                }
            </select>
        </div>

        <!-- Approved Row 3: Notes -->
        <div class="col-12">
            <label class="form-label">Approval Notes</label>
            <textarea name="ApprovalNotes" class="form-control" rows="2">@Model.ApprovalNotes</textarea>
        </div>

        <!-- Hidden field for InfStatus -->
        <input type="hidden" name="InfStatus" value="@Model.InfStatus" />

        <!-- Hidden legacy fields -->
        <input type="hidden" name="InfServiceLine" value="@Model.InfServiceLine" />
        <input type="hidden" name="ServiceLine" value="@Model.ServiceLine" />

        <!-- ============================================ -->
        <!-- SECTION: Resources -->
        <!-- ============================================ -->
        <div class="col-12 mt-4">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-warning text-dark rounded-circle d-flex align-items-center justify-content-center me-2"
                    style="width: 28px; height: 28px;">
                    <i class="bi bi-people"></i>
                </div>
                <h5 class="mb-0 text-warning fw-bold">Resources</h5>
            </div>
            <hr class="mt-0 mb-3" style="border-top: 2px solid var(--bs-warning); opacity: 0.5;" />
        </div>

        <div class="col-md-4">
            <label class="form-label">Sponsors</label>
            <select name="SponsorIds" class="form-select" multiple size="4">
                @foreach (var r in Model.AvailableSponsors)
                {
                    var selected = Model.SelectedSponsorIds.Contains(r.Id);
                    <option value="@r.Id" selected="@selected">@r.Name</option>
                }
            </select>
            <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
        </div>

        <div class="col-md-4">
            <label class="form-label">SPOCs</label>
            <select name="SpocIds" class="form-select" multiple size="4">
                @foreach (var r in Model.AvailableSpocs)
                {
                    var selected = Model.SelectedSpocIds.Contains(r.Id);
                    <option value="@r.Id" selected="@selected">@r.Name</option>
                }
            </select>
            <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
        </div>

        <div class="col-md-4">
            <label class="form-label">Assigned Resources</label>
            <select name="ResourceIds" class="form-select" multiple size="4">
                @foreach (var r in Model.AvailableResources)
                {
                    var selected = Model.SelectedResourceIds.Contains(r.Id);
                    <option value="@r.Id" selected="@selected">@r.Name</option>
                }
            </select>
            <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
        </div>

        <!-- ============================================ -->
        <!-- SECTION: Skills (Optional) -->
        <!-- ============================================ -->
        @if (Model.AvailableSkills?.Any() == true)
        {
            <div class="col-12 mt-4">
                <div class="d-flex align-items-center mb-2">
                    <div class="rounded-circle d-flex align-items-center justify-content-center me-2"
                        style="width: 28px; height: 28px; background-color: #6f42c1;">
                        <i class="bi bi-lightbulb text-white"></i>
                    </div>
                    <h5 class="mb-0 fw-bold" style="color: #6f42c1;">Skills</h5>
                </div>
                <hr class="mt-0 mb-3" style="border-top: 2px solid #6f42c1; opacity: 0.5;" />
            </div>

            <div class="col-12">
                <div class="row">
                    @foreach (var skill in Model.AvailableSkills)
                    {
                        var isChecked = Model.SelectedSkillIds.Contains(skill.Id);
                        <div class="col-md-4 col-lg-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="SkillIds" value="@skill.Id"
                                    id="skill_@skill.Id" @(isChecked ? "checked" : "") />
                                <label class="form-check-label small" for="skill_@skill.Id">@skill.Name</label>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- ============================================ -->
        <!-- SECTION: Time Categories (Optional) -->
        <!-- ============================================ -->
        @if (Model.AvailableTimeCategories?.Any() == true)
        {
            <div class="col-12 mt-4">
                <div class="d-flex align-items-center mb-2">
                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                        style="width: 28px; height: 28px;">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <h5 class="mb-0 text-secondary fw-bold">Time Categories</h5>
                </div>
                <hr class="mt-0 mb-3" style="border-top: 2px solid var(--bs-secondary); opacity: 0.5;" />
                <small class="text-muted d-block mb-2">Select categories for time recording on this enhancement. These
                    categories will be available for time recording.</small>
                <div class="row">
                    @foreach (var cat in Model.AvailableTimeCategories)
                    {
                        var isChecked = Model.SelectedTimeCategoryIds.Contains(cat.Id);
                        <div class="col-md-4 col-lg-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="TimeCategoryIds" value="@cat.Id"
                                    id="cat_@cat.Id" @(isChecked ? "checked" : "") />
                                <label class="form-check-label small" for="cat_@cat.Id">@cat.Name</label>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- ============================================ -->
        <!-- SECTION: Weekly Time Allocation (Legacy - Hidden) -->
        <!-- ============================================ -->
        <div class="col-12 mt-4" style="display:none;">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-purple text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                    style="width: 28px; height: 28px; background-color: #6f42c1;">
                    <i class="bi bi-calendar-week"></i>
                </div>
                <h5 class="mb-0 fw-bold" style="color: #6f42c1;">Weekly Time Allocation</h5>
            </div>
            <hr class="mt-0 mb-3" style="border-top: 2px solid #6f42c1; opacity: 0.5;" />
        </div>

        <div class="col-12" style="display:none;">
            <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0">
                    <thead class="table-light">
                        <tr>
                            @for (int w = 1; w <= 9; w++)
                            {
                                <th class="text-center" style="width: 11%;">W@w</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="number" name="TimeW1" value="@Model.TimeW1" class="form-control form-control-sm text-center" step="0.5" /></td>
                            <td><input type="number" name="TimeW2" value="@Model.TimeW2" class="form-control form-control-sm text-center" step="0.5" /></td>
                            <td><input type="number" name="TimeW3" value="@Model.TimeW3" class="form-control form-control-sm text-center" step="0.5" /></td>
                            <td><input type="number" name="TimeW4" value="@Model.TimeW4" class="form-control form-control-sm text-center" step="0.5" /></td>
                            <td><input type="number" name="TimeW5" value="@Model.TimeW5" class="form-control form-control-sm text-center" step="0.5" /></td>
                            <td><input type="number" name="TimeW6" value="@Model.TimeW6" class="form-control form-control-sm text-center" step="0.5" /></td>
                            <td><input type="number" name="TimeW7" value="@Model.TimeW7" class="form-control form-control-sm text-center" step="0.5" /></td>
                            <td><input type="number" name="TimeW8" value="@Model.TimeW8" class="form-control form-control-sm text-center" step="0.5" /></td>
                            <td><input type="number" name="TimeW9" value="@Model.TimeW9" class="form-control form-control-sm text-center" step="0.5" /></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- SECTION: Audit Information (Read-only) -->
        <!-- ============================================ -->
        @if (!isNew)
        {
            <div class="col-12 mt-4">
                <div class="d-flex align-items-center mb-2">
                    <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                        style="width: 28px; height: 28px;">
                        <i class="bi bi-clock-history"></i>
                    </div>
                    <h5 class="mb-0 text-secondary fw-bold">Audit Information</h5>
                </div>
                <hr class="mt-0 mb-3" style="border-top: 2px solid var(--bs-secondary); opacity: 0.5;" />
            </div>

            <div class="col-md-6">
                <label class="form-label">Created By</label>
                <input type="text" value="@Model.CreatedBy" class="form-control" readonly disabled />
            </div>

            <div class="col-md-6">
                <label class="form-label">Created At</label>
                <input type="text" value="@Model.CreatedAt?.ToString("yyyy-MM-dd HH:mm")" class="form-control" readonly disabled />
            </div>

            <div class="col-md-6">
                <label class="form-label">Modified By</label>
                <input type="text" value="@Model.ModifiedBy" class="form-control" readonly disabled />
            </div>

            <div class="col-md-6">
                <label class="form-label">Modified At</label>
                <input type="text" value="@Model.ModifiedAt?.ToString("yyyy-MM-dd HH:mm")" class="form-control" readonly disabled />
            </div>
        }

        <!-- ============================================ -->
        <!-- Save Button -->
        <!-- ============================================ -->
        <div class="col-12 mt-4">
            <hr />
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg me-1"></i> @(isNew ? "Create Enhancement" : "Save Changes")
                    </button>
                    @if (!isNew)
                    {
                        <a href="/EnhancementDetails/Details/@Model.Id?serviceAreaId=@Model.ServiceAreaId" class="btn btn-outline-secondary ms-2">
                            <i class="bi bi-x-lg me-1"></i> Cancel
                        </a>
                    }
                </div>
                @if (!isNew)
                {
                    <button type="button" class="btn btn-outline-danger" id="deleteEnhancementBtn">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                }
            </div>
        </div>

    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var form = document.getElementById('ticketDetailsForm');
        if (!form) {
            console.error('Form not found');
            return;
        }

        var tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
        if (!tokenInput) {
            console.error('Anti-forgery token not found');
            return;
        }
        var antiForgeryToken = tokenInput.value;

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            var formData = new FormData(form);
            var data = {
                id: formData.get('Id'),
                workId: formData.get('WorkId'),
                description: formData.get('Description'),
                notes: formData.get('Notes'),
                status: formData.get('Status'),
                serviceAreaId: formData.get('ServiceAreaId'),
                serviceLine: formData.get('ServiceLine'),
                // Sizing fields
                estimatedHours: parseFloat(formData.get('EstimatedHours')) || null,
                estimatedStartDate: formData.get('EstimatedStartDate') || null,
                estimatedEndDate: formData.get('EstimatedEndDate') || null,
                estimationNotes: formData.get('EstimationNotes'),
                estimatedStatus: formData.get('EstimatedStatus'),
                estimatedLaborType: formData.get('EstimatedLaborType'),
                estimatedPriority: formData.get('EstimatedPriority'),
                // Approved fields
                returnedHours: parseFloat(formData.get('ReturnedHours')) || null,
                startDate: formData.get('StartDate') || null,
                endDate: formData.get('EndDate') || null,
                infStatus: formData.get('InfStatus'),
                infServiceLine: formData.get('InfServiceLine'),
                infLaborType: formData.get('InfLaborType'),
                infPriority: formData.get('InfPriority'),
                approvalNotes: formData.get('ApprovalNotes'),
                // Legacy time allocations
                timeW1: parseFloat(formData.get('TimeW1')) || null,
                timeW2: parseFloat(formData.get('TimeW2')) || null,
                timeW3: parseFloat(formData.get('TimeW3')) || null,
                timeW4: parseFloat(formData.get('TimeW4')) || null,
                timeW5: parseFloat(formData.get('TimeW5')) || null,
                timeW6: parseFloat(formData.get('TimeW6')) || null,
                timeW7: parseFloat(formData.get('TimeW7')) || null,
                timeW8: parseFloat(formData.get('TimeW8')) || null,
                timeW9: parseFloat(formData.get('TimeW9')) || null,
                // Resource selections
                sponsorIds: formData.getAll('SponsorIds'),
                spocIds: formData.getAll('SpocIds'),
                resourceIds: formData.getAll('ResourceIds'),
                skillIds: formData.getAll('SkillIds'),
                timeCategoryIds: formData.getAll('TimeCategoryIds')
            };

            var btn = form.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Saving...';

            fetch('/Enhancements/SaveDetails', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': antiForgeryToken
                },
                body: JSON.stringify(data)
            })
                .then(function (r) { return r.json(); })
                .then(function (result) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Save Changes';

                    if (result.success) {
                        alert('Saved successfully!');
                        if (!data.id && result.id) {
                            window.location.href = '/EnhancementDetails/Details/' + result.id + '?serviceAreaId=' + data.serviceAreaId;
                        }
                    } else {
                        alert(result.message || 'Save failed');
                    }
                })
                .catch(function (err) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-check-lg me-1"></i> Save Changes';
                    alert('Error saving: ' + err.message);
                });
        });
    });
</script>
