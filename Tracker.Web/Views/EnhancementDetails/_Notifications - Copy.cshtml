@model EnhancementDetailsViewModel
@{
    var notifications = Model.Notifications;
}

<div class="row">
    <div class="col-12">
        <div class="d-flex align-items-center mb-3">
            <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                <i class="bi bi-bell-fill"></i>
            </div>
            <div>
                <h5 class="mb-0 text-danger fw-bold">Notification Recipients</h5>
                <small class="text-muted">Select people to receive notifications about this enhancement</small>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Current Recipients -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="bi bi-people-fill me-1"></i> 
                    Current Recipients
                    @if (notifications.CurrentRecipients.Any())
                    {
                        <span class="badge bg-primary ms-1">@notifications.CurrentRecipients.Count</span>
                    }
                </h6>
            </div>
            <div class="card-body p-0">
                @if (notifications.CurrentRecipients.Any())
                {
                    <div class="list-group list-group-flush" id="currentRecipientsList">
                        @foreach (var recipient in notifications.CurrentRecipients.OrderBy(r => r.ResourceName))
                        {
                            <div class="list-group-item d-flex justify-content-between align-items-center recipient-item" data-id="@recipient.Id" data-resource-id="@recipient.ResourceId">
                                <div>
                                    <div class="fw-medium">@recipient.ResourceName</div>
                                    @if (!string.IsNullOrEmpty(recipient.Email))
                                    {
                                        <small class="text-muted"><i class="bi bi-envelope me-1"></i>@recipient.Email</small>
                                    }
                                    @if (!string.IsNullOrEmpty(recipient.ResourceType))
                                    {
                                        <span class="badge bg-secondary ms-2">@recipient.ResourceType</span>
                                    }
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger remove-recipient-btn" 
                                        data-id="@recipient.Id" title="Remove from notifications">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-4" id="noRecipientsMsg">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        <p class="mb-0">No recipients assigned</p>
                        <small>Add people from the available resources list</small>
                    </div>
                }
            </div>
        </div>
    </div>
    
    <!-- Available Resources -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="bi bi-person-plus me-1"></i> 
                    Available Resources
                </h6>
            </div>
            <div class="card-header bg-white border-bottom-0 pb-0">
                <input type="text" class="form-control form-control-sm" id="searchAvailableResources" 
                       placeholder="Search by name or email..." />
            </div>
            <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                @if (notifications.AvailableResources.Any())
                {
                    <div class="list-group list-group-flush" id="availableResourcesList">
                        @foreach (var resource in notifications.AvailableResources.OrderBy(r => r.Name))
                        {
                            var isAlreadyAdded = notifications.SelectedRecipientIds.Contains(resource.Id);
                            <div class="list-group-item d-flex justify-content-between align-items-center available-resource-item @(isAlreadyAdded ? "d-none" : "")" 
                                 data-id="@resource.Id" data-name="@resource.Name" data-email="@resource.Email" data-type="@resource.ResourceType">
                                <div>
                                    <div class="fw-medium">@resource.Name</div>
                                    @if (!string.IsNullOrEmpty(resource.Email))
                                    {
                                        <small class="text-muted"><i class="bi bi-envelope me-1"></i>@resource.Email</small>
                                    }
                                    @if (!string.IsNullOrEmpty(resource.ResourceType))
                                    {
                                        <span class="badge bg-secondary ms-2">@resource.ResourceType</span>
                                    }
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-success add-recipient-btn" 
                                        data-id="@resource.Id" data-name="@resource.Name" data-email="@resource.Email" data-type="@resource.ResourceType"
                                        title="Add to notifications">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-people fs-1 d-block mb-2"></i>
                        <p class="mb-0">No resources available</p>
                        <small>Add resources to this service area first</small>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Quick Add All Section -->
@if (notifications.AvailableResources.Any())
{
    <div class="row mt-3">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center justify-content-between">
                        <span class="text-muted small">
                            <i class="bi bi-lightning me-1"></i> Quick Actions
                        </span>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" id="addAllSponsorsBtn">
                                <i class="bi bi-star me-1"></i> Add All Sponsors
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" id="addAllSpocsBtn">
                                <i class="bi bi-person-badge me-1"></i> Add All SPOCs
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="addAllResourcesBtn">
                                <i class="bi bi-people me-1"></i> Add All Assigned
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<input type="hidden" id="enhancementIdForNotifications" value="@Model.Id" />

@section Scripts {
<script>
(function() {
    var enhancementId = document.getElementById('enhancementIdForNotifications').value;
    var antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;
    
    // Search filter
    var searchInput = document.getElementById('searchAvailableResources');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            var query = this.value.toLowerCase();
            document.querySelectorAll('.available-resource-item').forEach(function(item) {
                var name = (item.dataset.name || '').toLowerCase();
                var email = (item.dataset.email || '').toLowerCase();
                var matches = name.includes(query) || email.includes(query);
                
                // Only show if matches AND not already added
                if (matches && !item.classList.contains('added-recipient')) {
                    item.classList.remove('d-none');
                } else {
                    item.classList.add('d-none');
                }
            });
        });
    }
    
    // Add recipient
    document.querySelectorAll('.add-recipient-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            addRecipient(this.dataset.id, this.dataset.name, this.dataset.email, this.dataset.type);
        });
    });
    
    function addRecipient(resourceId, name, email, type) {
        fetch('@Url.Action("AddNotificationRecipient", "EnhancementDetails")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': antiForgeryToken
            },
            body: JSON.stringify({
                enhancementId: enhancementId,
                resourceId: resourceId
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                // Hide from available list
                var availableItem = document.querySelector('.available-resource-item[data-id="' + resourceId + '"]');
                if (availableItem) {
                    availableItem.classList.add('d-none', 'added-recipient');
                }
                
                // Add to current recipients
                var recipientsList = document.getElementById('currentRecipientsList');
                var noMsg = document.getElementById('noRecipientsMsg');
                
                if (noMsg) {
                    noMsg.remove();
                    // Create list if it doesn't exist
                    if (!recipientsList) {
                        var cardBody = document.querySelector('.col-md-6:first-child .card-body');
                        cardBody.innerHTML = '<div class="list-group list-group-flush" id="currentRecipientsList"></div>';
                        recipientsList = document.getElementById('currentRecipientsList');
                    }
                }
                
                var newItem = document.createElement('div');
                newItem.className = 'list-group-item d-flex justify-content-between align-items-center recipient-item';
                newItem.dataset.id = data.recipientId;
                newItem.dataset.resourceId = resourceId;
                newItem.innerHTML = '<div>' +
                    '<div class="fw-medium">' + escapeHtml(name) + '</div>' +
                    (email ? '<small class="text-muted"><i class="bi bi-envelope me-1"></i>' + escapeHtml(email) + '</small>' : '') +
                    (type ? '<span class="badge bg-secondary ms-2">' + escapeHtml(type) + '</span>' : '') +
                    '</div>' +
                    '<button type="button" class="btn btn-sm btn-outline-danger remove-recipient-btn" data-id="' + data.recipientId + '" title="Remove from notifications">' +
                    '<i class="bi bi-x-lg"></i></button>';
                
                recipientsList.appendChild(newItem);
                
                // Attach remove listener
                newItem.querySelector('.remove-recipient-btn').addEventListener('click', function() {
                    removeRecipient(this.dataset.id);
                });
                
                // Update badge
                updateRecipientCount();
            } else {
                alert(data.message || 'Failed to add recipient');
            }
        });
    }
    
    // Remove recipient
    document.querySelectorAll('.remove-recipient-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            removeRecipient(this.dataset.id);
        });
    });
    
    function removeRecipient(recipientId) {
        fetch('@Url.Action("RemoveNotificationRecipient", "EnhancementDetails")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': antiForgeryToken
            },
            body: JSON.stringify({
                recipientId: recipientId
            })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                // Get the resource ID before removing
                var recipientItem = document.querySelector('.recipient-item[data-id="' + recipientId + '"]');
                var resourceId = recipientItem ? recipientItem.dataset.resourceId : null;
                
                // Remove from current recipients
                if (recipientItem) {
                    recipientItem.remove();
                }
                
                // Show in available list again
                if (resourceId) {
                    var availableItem = document.querySelector('.available-resource-item[data-id="' + resourceId + '"]');
                    if (availableItem) {
                        availableItem.classList.remove('d-none', 'added-recipient');
                    }
                }
                
                // Show no recipients message if empty
                var recipientsList = document.getElementById('currentRecipientsList');
                if (recipientsList && recipientsList.children.length === 0) {
                    var cardBody = document.querySelector('.col-md-6:first-child .card-body');
                    cardBody.innerHTML = '<div class="text-center text-muted py-4" id="noRecipientsMsg">' +
                        '<i class="bi bi-inbox fs-1 d-block mb-2"></i>' +
                        '<p class="mb-0">No recipients assigned</p>' +
                        '<small>Add people from the available resources list</small></div>';
                }
                
                // Update badge
                updateRecipientCount();
            } else {
                alert(data.message || 'Failed to remove recipient');
            }
        });
    }
    
    function updateRecipientCount() {
        var badge = document.querySelector('.col-md-6:first-child .card-header .badge');
        var count = document.querySelectorAll('.recipient-item').length;
        
        if (count > 0) {
            if (badge) {
                badge.textContent = count;
            } else {
                var header = document.querySelector('.col-md-6:first-child .card-header h6');
                var newBadge = document.createElement('span');
                newBadge.className = 'badge bg-primary ms-1';
                newBadge.textContent = count;
                header.appendChild(newBadge);
            }
        } else {
            if (badge) badge.remove();
        }
    }
    
    // Quick add buttons
    document.getElementById('addAllSponsorsBtn')?.addEventListener('click', function() {
        addMultipleByType('Client');
    });
    
    document.getElementById('addAllSpocsBtn')?.addEventListener('click', function() {
        addMultipleByType('SPOC');
    });
    
    document.getElementById('addAllResourcesBtn')?.addEventListener('click', function() {
        addMultipleByType('Internal');
    });
    
    function addMultipleByType(type) {
        var items = document.querySelectorAll('.available-resource-item:not(.d-none)[data-type="' + type + '"]');
        items.forEach(function(item) {
            var btn = item.querySelector('.add-recipient-btn');
            if (btn) {
                addRecipient(btn.dataset.id, btn.dataset.name, btn.dataset.email, btn.dataset.type);
            }
        });
    }
    
    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
})();
</script>
}
