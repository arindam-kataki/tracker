@model Tracker.Web.ViewModels.EditResourceViewModel
@{
    ViewData["Title"] = Model.PageTitle;
    var isLastAdminDisabled = Model.IsLastAdmin ? "disabled" : null;
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">
        <i class="bi bi-person me-2"></i>@Model.PageTitle
        @if (Model.IsAdmin)
        {
            <span class="badge bg-danger ms-2">Administrator</span>
        }
    </h4>
    <a href="/resources" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Back to Resources
    </a>
</div>

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        <ul class="mb-0">
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@error.ErrorMessage</li>
            }
        </ul>
    </div>
}

@if (Model.IsLastAdmin)
{
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>This is the last administrator.</strong> Admin status and login access cannot be removed.
    </div>
}

<form method="post" action="/resources/save" id="resourceForm">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    
    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="resourceTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic-panel" type="button" role="tab">
                <i class="bi bi-person-badge me-1"></i> Basic Info
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="access-tab" data-bs-toggle="tab" data-bs-target="#access-panel" type="button" role="tab">
                <i class="bi bi-shield-lock me-1"></i> Login & Access
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="skills-tab" data-bs-toggle="tab" data-bs-target="#skills-panel" type="button" role="tab">
                <i class="bi bi-tools me-1"></i> Skills
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="availability-tab" data-bs-toggle="tab" data-bs-target="#availability-panel" type="button" role="tab">
                <i class="bi bi-calendar3 me-1"></i> Availability
            </button>
        </li>
    </ul>
    
    <div class="tab-content">
        <!-- TAB 1: Basic Info -->
        <div class="tab-pane fade show active" id="basic-panel" role="tabpanel">
            <div class="row">
                <div class="col-lg-5">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Resource Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label asp-for="Name" class="form-label">Name <span class="text-danger">*</span></label>
                                <input asp-for="Name" class="form-control" placeholder="Full name" />
                                <span asp-validation-for="Name" class="text-danger small"></span>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="Email" class="form-label">Email</label>
                                    <input asp-for="Email" type="email" class="form-control" placeholder="email@example.com" />
                                    <span asp-validation-for="Email" class="text-danger small"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="Phone" class="form-label">Phone</label>
                                    <input asp-for="Phone" class="form-control" placeholder="+1 (555) 123-4567" />
                                    <span asp-validation-for="Phone" class="text-danger small"></span>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label asp-for="OrganizationType" class="form-label">Organization Type <span class="text-danger">*</span></label>
                                    <select asp-for="OrganizationType" asp-items="Model.OrganizationTypeOptions" class="form-select"></select>
                                    <small class="text-muted">Determines which enhancement columns this resource can appear in</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="form-check mt-2">
                                        <input asp-for="IsActive" class="form-check-input" />
                                        <label asp-for="IsActive" class="form-check-label">Active</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-7">
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Service Area Memberships</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="addServiceAreaBtn">
                                <i class="bi bi-plus-lg me-1"></i> Add Service Area
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="serviceAreaMemberships">
                                @if (Model.ServiceAreaMemberships?.Any() == true)
                                {
                                    for (int i = 0; i < Model.ServiceAreaMemberships.Count; i++)
                                    {
                                        ViewData["Index"] = i;
                                        @await Html.PartialAsync("_ServiceAreaMembership", Model.ServiceAreaMemberships[i], ViewData)
                                    }
                                }
                                else
                                {
                                    <div id="noMembershipsMessage" class="text-center text-muted py-4">
                                        <i class="bi bi-diagram-3 display-6 d-block mb-2"></i>
                                        No service area memberships. Click "Add Service Area" to add one.
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 2: Login & Access -->
        <div class="tab-pane fade" id="access-panel" role="tabpanel">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Login Access</h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                @if (Model.IsLastAdmin)
                                {
                                    <input asp-for="HasLoginAccess" class="form-check-input" id="hasLoginAccess" disabled />
                                    <input type="hidden" asp-for="HasLoginAccess" />
                                }
                                else
                                {
                                    <input asp-for="HasLoginAccess" class="form-check-input" id="hasLoginAccess" />
                                }
                                <label class="form-check-label" for="hasLoginAccess">
                                    <strong>Enable Login Access</strong>
                                </label>
                                <div class="form-text">Allow this person to log in to the system</div>
                            </div>
                            
                            <div id="loginOptionsSection" style="display: @(Model.HasLoginAccess ? "block" : "none");">
                                <hr />
                                
                                <div class="mb-3">
                                    <label asp-for="NewPassword" class="form-label">
                                        @(Model.IsNew ? "Password" : "New Password")
                                        @if (Model.IsNew)
                                        {
                                            <span class="text-danger">*</span>
                                        }
                                    </label>
                                    <input asp-for="NewPassword" type="password" class="form-control" 
                                           placeholder="@(Model.IsNew ? "Enter password" : "Leave blank to keep current")" />
                                    <span asp-validation-for="NewPassword" class="text-danger small"></span>
                                    <small class="text-muted">Minimum 8 characters</small>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    @if (Model.IsLastAdmin)
                                    {
                                        <input asp-for="IsAdmin" class="form-check-input" id="isAdmin" disabled />
                                        <input type="hidden" asp-for="IsAdmin" />
                                    }
                                    else
                                    {
                                        <input asp-for="IsAdmin" class="form-check-input" id="isAdmin" />
                                    }
                                    <label class="form-check-label" for="isAdmin">
                                        <strong>Administrator</strong>
                                        <span class="badge bg-danger ms-1">SuperAdmin</span>
                                    </label>
                                    <div class="form-text">Full access to all features and all service areas</div>
                                </div>
                                
                                <div class="form-check form-switch mb-3">
                                    <input asp-for="CanConsolidate" class="form-check-input" />
                                    <label asp-for="CanConsolidate" class="form-check-label">
                                        <strong>Can Consolidate</strong>
                                    </label>
                                    <div class="form-text">Access to the Consolidation feature</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Login History</h6>
                        </div>
                        <div class="card-body">
                            @if (Model.IsNew)
                            {
                                <p class="text-muted mb-0">No login history available for new resources.</p>
                            }
                            else if (Model.LastLoginAt.HasValue)
                            {
                                <p class="mb-0">
                                    <strong>Last Login:</strong> @Model.LastLoginAt.Value.ToString("MMMM dd, yyyy 'at' HH:mm")
                                </p>
                            }
                            else
                            {
                                <p class="text-muted mb-0">This resource has never logged in.</p>
                            }
                        </div>
                    </div>
                    
                    @if (!Model.IsNew && Model.HasLoginAccess)
                    {
                        <div class="card mb-3 border-warning">
                            <div class="card-header bg-warning bg-opacity-10">
                                <h6 class="mb-0"><i class="bi bi-key me-2"></i>Password Reset</h6>
                            </div>
                            <div class="card-body">
                                <p class="small text-muted mb-2">Generate a new password for this user:</p>
                                <form method="post" action="/resources/reset-password/@Model.Id" id="resetPasswordForm">
                                    @Html.AntiForgeryToken()
                                    <div class="input-group">
                                        <input type="password" name="newPassword" class="form-control" placeholder="New password (min 8 chars)" />
                                        <button type="submit" class="btn btn-warning" onclick="return confirm('Reset password for this user?')">
                                            <i class="bi bi-key me-1"></i> Reset
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
        
        <!-- TAB 3: Skills -->
        <div class="tab-pane fade" id="skills-panel" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-tools me-2"></i>Skills</h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Select skills for this resource. Skills are grouped by Service Area.</p>
                    
                    @if (Model.AvailableSkillsGrouped?.Any() != true)
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-tools display-6 d-block mb-2"></i>
                            No skills available. Add skills in the Lookups section first.
                        </div>
                    }
                    else
                    {
                        var memberServiceAreaIds = Model.ServiceAreaMemberships?.Select(sa => sa.ServiceAreaId).ToHashSet() ?? new HashSet<string>();
                        
                        @foreach (var group in Model.AvailableSkillsGrouped)
                        {
                            var isMember = memberServiceAreaIds.Contains(group.ServiceAreaId);
                            <div class="card mb-3 @(!isMember ? "border-warning" : "")">
                                <div class="card-header py-2 @(!isMember ? "bg-warning bg-opacity-10" : "bg-light")">
                                    <strong>@group.ServiceAreaCode - @group.ServiceAreaName</strong>
                                    @if (!isMember)
                                    {
                                        <span class="badge bg-warning text-dark ms-2">
                                            <i class="bi bi-exclamation-triangle me-1"></i>Not a member
                                        </span>
                                    }
                                </div>
                                <div class="card-body py-2">
                                    @if (!group.Skills.Any())
                                    {
                                        <span class="text-muted">No skills defined for this service area</span>
                                    }
                                    else
                                    {
                                        <div class="row">
                                            @foreach (var skill in group.Skills)
                                            {
                                                <div class="col-md-4 col-lg-3">
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input" 
                                                               name="SelectedSkillIds" value="@skill.Id" 
                                                               id="skill_@skill.Id" checked="@skill.IsSelected" />
                                                        <label class="form-check-label" for="skill_@skill.Id" title="@skill.Description">
                                                            @skill.Name
                                                        </label>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
        
        <!-- TAB 4: Availability -->
        <div class="tab-pane fade" id="availability-panel" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Availability</h6>
                </div>
                <div class="card-body">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-hourglass display-4 d-block mb-3"></i>
                        <h5>Coming Soon</h5>
                        <p class="mb-0">This feature is planned for a future release.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Button -->
    <div class="card mt-3">
        <div class="card-body d-flex justify-content-between">
            <a href="/resources" class="btn btn-outline-secondary">
                <i class="bi bi-x-lg me-1"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-1"></i> @(Model.IsNew ? "Create Resource" : "Save Changes")
            </button>
        </div>
    </div>
</form>

<!-- Add Service Area Modal -->
<div class="modal fade" id="addServiceAreaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-lg me-2"></i>Add Service Area Membership</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newServiceAreaId" class="form-label">Service Area</label>
                    <select id="newServiceAreaId" class="form-select">
                        <option value="">-- Select Service Area --</option>
                        @foreach (var sa in Model.AvailableServiceAreas ?? new List<ServiceAreaOption>())
                        {
                            <option value="@sa.Id" data-code="@sa.Code" data-name="@sa.Name">@sa.Code - @sa.Name</option>
                        }
                    </select>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="newIsPrimary" />
                    <label class="form-check-label" for="newIsPrimary">Set as Primary Service Area</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddServiceArea">
                    <i class="bi bi-plus-lg me-1"></i> Add
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function() {
    var membershipIndex = @(Model.ServiceAreaMemberships?.Count ?? 0);
    var addedServiceAreas = [@Html.Raw(string.Join(",", (Model.ServiceAreaMemberships ?? new List<EditResourceServiceAreaViewModel>()).Select(sa => $"'{sa.ServiceAreaId}'")))];
    var addModal = new bootstrap.Modal(document.getElementById('addServiceAreaModal'));
    
    // Toggle login options
    var hasLoginCheckbox = document.getElementById('hasLoginAccess');
    var loginOptionsSection = document.getElementById('loginOptionsSection');
    
    if (hasLoginCheckbox) {
        hasLoginCheckbox.addEventListener('change', function() {
            loginOptionsSection.style.display = this.checked ? 'block' : 'none';
            if (!this.checked) {
                var isAdminCheckbox = document.getElementById('isAdmin');
                if (isAdminCheckbox) isAdminCheckbox.checked = false;
            }
        });
    }
    
    document.getElementById('addServiceAreaBtn').addEventListener('click', function() {
        updateServiceAreaDropdown();
        addModal.show();
    });
    
    document.getElementById('confirmAddServiceArea').addEventListener('click', function() {
        var select = document.getElementById('newServiceAreaId');
        var serviceAreaId = select.value;
        if (!serviceAreaId) { alert('Please select a service area'); return; }
        
        var isPrimary = document.getElementById('newIsPrimary').checked;
        
        fetch('/resources/service-area-membership-template?serviceAreaId=' + encodeURIComponent(serviceAreaId) + '&index=' + membershipIndex)
            .then(function(r) { return r.text(); })
            .then(function(html) {
                var noMsg = document.getElementById('noMembershipsMessage');
                if (noMsg) noMsg.remove();
                
                var container = document.getElementById('serviceAreaMemberships');
                var div = document.createElement('div');
                div.innerHTML = html;
                container.appendChild(div.firstElementChild);
                
                if (isPrimary) setPrimaryServiceArea(membershipIndex);
                
                addedServiceAreas.push(serviceAreaId);
                membershipIndex++;
                select.value = '';
                document.getElementById('newIsPrimary').checked = false;
                addModal.hide();
            });
    });
    
    function updateServiceAreaDropdown() {
        var select = document.getElementById('newServiceAreaId');
        select.querySelectorAll('option').forEach(function(opt) {
            if (opt.value && addedServiceAreas.includes(opt.value)) {
                opt.disabled = true;
                opt.textContent = opt.dataset.code + ' - ' + opt.dataset.name + ' (already added)';
            } else if (opt.value) {
                opt.disabled = false;
                opt.textContent = opt.dataset.code + ' - ' + opt.dataset.name;
            }
        });
    }
    
    document.getElementById('serviceAreaMemberships').addEventListener('click', function(e) {
        var removeBtn = e.target.closest('.remove-membership-btn');
        if (removeBtn) {
            var card = removeBtn.closest('.sa-membership-card');
            var idx = addedServiceAreas.indexOf(card.dataset.serviceAreaId);
            if (idx > -1) addedServiceAreas.splice(idx, 1);
            card.remove();
            
            var container = document.getElementById('serviceAreaMemberships');
            if (container.querySelectorAll('.sa-membership-card').length === 0) {
                container.innerHTML = '<div id="noMembershipsMessage" class="text-center text-muted py-4"><i class="bi bi-diagram-3 display-6 d-block mb-2"></i>No service area memberships.</div>';
            }
            reindexMemberships();
        }
    });
    
    document.getElementById('serviceAreaMemberships').addEventListener('change', function(e) {
        if (e.target.classList.contains('primary-checkbox') && e.target.checked) {
            setPrimaryServiceArea(parseInt(e.target.closest('.sa-membership-card').dataset.index));
        }
    });
    
    function setPrimaryServiceArea(primaryIndex) {
        document.querySelectorAll('.primary-checkbox').forEach(function(cb) {
            var card = cb.closest('.sa-membership-card');
            var idx = parseInt(card.dataset.index);
            cb.checked = (idx === primaryIndex);
            var badge = card.querySelector('.primary-badge');
            badge.classList.toggle('d-none', idx !== primaryIndex);
        });
    }
    
    function reindexMemberships() {
        var cards = document.querySelectorAll('.sa-membership-card');
        cards.forEach(function(card, i) {
            card.dataset.index = i;
            card.querySelectorAll('input, select').forEach(function(inp) {
                if (inp.name) inp.name = inp.name.replace(/\[\d+\]/, '[' + i + ']');
                if (inp.id) inp.id = inp.id.replace(/_\d+$/, '_' + i);
            });
            card.querySelectorAll('label').forEach(function(lbl) {
                var f = lbl.getAttribute('for');
                if (f) lbl.setAttribute('for', f.replace(/_\d+$/, '_' + i));
            });
        });
        membershipIndex = cards.length;
    }
})();
</script>
}
