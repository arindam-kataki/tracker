@model Tracker.Web.ViewModels.EditResourceViewModel
@{
    ViewData["Title"] = Model.PageTitle;
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">
        <i class="bi bi-person me-2"></i>@Model.PageTitle
    </h4>
    <a href="/resources" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Back to Resources
    </a>
</div>

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        <ul class="mb-0">
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@error.ErrorMessage</li>
            }
        </ul>
    </div>
}

<form method="post" action="/resources/save" id="resourceForm">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    
    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="resourceTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic-panel" 
                    type="button" role="tab">
                <i class="bi bi-person-badge me-1"></i> Basic Info
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="skills-tab" data-bs-toggle="tab" data-bs-target="#skills-panel" 
                    type="button" role="tab">
                <i class="bi bi-tools me-1"></i> Skills
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="availability-tab" data-bs-toggle="tab" data-bs-target="#availability-panel" 
                    type="button" role="tab">
                <i class="bi bi-calendar3 me-1"></i> Availability
            </button>
        </li>
    </ul>
    
    <div class="tab-content">
        <!-- TAB 1: Basic Info -->
        <div class="tab-pane fade show active" id="basic-panel" role="tabpanel">
            <div class="row">
                <!-- Left Column: Resource Details -->
                <div class="col-lg-5">
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Resource Details</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label asp-for="Name" class="form-label">Name <span class="text-danger">*</span></label>
                                <input asp-for="Name" class="form-control" placeholder="Full name" />
                                <span asp-validation-for="Name" class="text-danger small"></span>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="Email" class="form-label">Email</label>
                                    <input asp-for="Email" type="email" class="form-control" placeholder="email@example.com" />
                                    <span asp-validation-for="Email" class="text-danger small"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="Phone" class="form-label">Phone</label>
                                    <input asp-for="Phone" class="form-control" placeholder="+1 (555) 123-4567" />
                                    <span asp-validation-for="Phone" class="text-danger small"></span>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label asp-for="OrganizationType" class="form-label">Organization Type <span class="text-danger">*</span></label>
                                    <select asp-for="OrganizationType" asp-items="Model.OrganizationTypeOptions" class="form-select"></select>
                                    <small class="text-muted">Determines which enhancement columns this resource can appear in</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="form-check mt-2">
                                        <input asp-for="IsActive" class="form-check-input" />
                                        <label asp-for="IsActive" class="form-check-label">Active</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Service Area Memberships -->
                <div class="col-lg-7">
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Service Area Memberships</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="addServiceAreaBtn">
                                <i class="bi bi-plus-lg me-1"></i> Add Service Area
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="serviceAreaMemberships">
                                @if (Model.ServiceAreaMemberships?.Any() == true)
                                {
                                    for (int i = 0; i < Model.ServiceAreaMemberships.Count; i++)
                                    {
                                        ViewData["Index"] = i;
                                        @await Html.PartialAsync("_ServiceAreaMembership", Model.ServiceAreaMemberships[i], ViewData)
                                    }
                                }
                                else
                                {
                                    <div id="noMembershipsMessage" class="text-center text-muted py-4">
                                        <i class="bi bi-diagram-3 display-6 d-block mb-2"></i>
                                        No service area memberships. Click "Add Service Area" to add one.
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- TAB 2: Skills -->
        <div class="tab-pane fade" id="skills-panel" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-tools me-2"></i>Skills</h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Select skills for this resource. Skills are grouped by Service Area.
                    </p>
                    
                    @if (Model.AvailableSkillsGrouped?.Any() != true)
                    {
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-tools display-6 d-block mb-2"></i>
                            No skills available. Add skills in the Lookups section first.
                        </div>
                    }
                    else
                    {
                        var memberServiceAreaIds = Model.ServiceAreaMemberships?.Select(sa => sa.ServiceAreaId).ToHashSet() ?? new HashSet<string>();
                        
                        @foreach (var group in Model.AvailableSkillsGrouped)
                        {
                            var isMember = memberServiceAreaIds.Contains(group.ServiceAreaId);
                            <div class="card mb-3 @(!isMember ? "border-warning" : "")">
                                <div class="card-header py-2 @(!isMember ? "bg-warning bg-opacity-10" : "bg-light")">
                                    <strong>@group.ServiceAreaCode - @group.ServiceAreaName</strong>
                                    @if (!isMember)
                                    {
                                        <span class="badge bg-warning text-dark ms-2" title="Resource is not a member of this service area">
                                            <i class="bi bi-exclamation-triangle me-1"></i>Not a member
                                        </span>
                                    }
                                </div>
                                <div class="card-body py-2">
                                    @if (!group.Skills.Any())
                                    {
                                        <span class="text-muted">No skills defined for this service area</span>
                                    }
                                    else
                                    {
                                        <div class="row">
                                            @foreach (var skill in group.Skills)
                                            {
                                                <div class="col-md-4 col-lg-3">
                                                    <div class="form-check">
                                                        <input type="checkbox" class="form-check-input" 
                                                               name="SelectedSkillIds" value="@skill.Id" 
                                                               id="skill_@skill.Id"
                                                               checked="@skill.IsSelected" />
                                                        <label class="form-check-label" for="skill_@skill.Id" 
                                                               title="@skill.Description">
                                                            @skill.Name
                                                        </label>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
        
        <!-- TAB 3: Availability -->
        <div class="tab-pane fade" id="availability-panel" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Availability</h6>
                </div>
                <div class="card-body">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-hourglass display-4 d-block mb-3"></i>
                        <h5>Coming Soon</h5>
                        <p class="mb-0">This feature is planned for a future release.</p>
                        <p class="small">Planned functionality includes:</p>
                        <ul class="list-unstyled small">
                            <li><i class="bi bi-check text-success me-1"></i> Calendar-based availability tracking</li>
                            <li><i class="bi bi-check text-success me-1"></i> Planned leave / PTO management</li>
                            <li><i class="bi bi-check text-success me-1"></i> Capacity planning per service area</li>
                            <li><i class="bi bi-check text-success me-1"></i> Integration with timesheet data</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save Button -->
    <div class="card mt-3">
        <div class="card-body d-flex justify-content-between">
            <a href="/resources" class="btn btn-outline-secondary">
                <i class="bi bi-x-lg me-1"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg me-1"></i> @(Model.IsNew ? "Create Resource" : "Save Changes")
            </button>
        </div>
    </div>
</form>

<!-- Add Service Area Modal -->
<div class="modal fade" id="addServiceAreaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-lg me-2"></i>Add Service Area Membership</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newServiceAreaId" class="form-label">Service Area</label>
                    <select id="newServiceAreaId" class="form-select">
                        <option value="">-- Select Service Area --</option>
                        @foreach (var sa in Model.AvailableServiceAreas ?? new List<ServiceAreaOption>())
                        {
                            <option value="@sa.Id" data-code="@sa.Code" data-name="@sa.Name">
                                @sa.Code - @sa.Name
                            </option>
                        }
                    </select>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="newIsPrimary" />
                    <label class="form-check-label" for="newIsPrimary">Set as Primary Service Area</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddServiceArea">
                    <i class="bi bi-plus-lg me-1"></i> Add
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function() {
    var membershipIndex = @(Model.ServiceAreaMemberships?.Count ?? 0);
    var addedServiceAreas = [@Html.Raw(string.Join(",", (Model.ServiceAreaMemberships ?? new List<EditResourceServiceAreaViewModel>()).Select(sa => $"'{sa.ServiceAreaId}'")))];
    var addModal = new bootstrap.Modal(document.getElementById('addServiceAreaModal'));
    
    // Add Service Area button
    document.getElementById('addServiceAreaBtn').addEventListener('click', function() {
        updateServiceAreaDropdown();
        addModal.show();
    });
    
    // Confirm Add Service Area
    document.getElementById('confirmAddServiceArea').addEventListener('click', function() {
        var select = document.getElementById('newServiceAreaId');
        var serviceAreaId = select.value;
        
        if (!serviceAreaId) {
            alert('Please select a service area');
            return;
        }
        
        var isPrimary = document.getElementById('newIsPrimary').checked;
        
        // Fetch the partial view for the new membership
        fetch('/resources/service-area-membership-template?serviceAreaId=' + encodeURIComponent(serviceAreaId) + '&index=' + membershipIndex)
            .then(function(response) { return response.text(); })
            .then(function(html) {
                // Remove "no memberships" message if present
                var noMsg = document.getElementById('noMembershipsMessage');
                if (noMsg) noMsg.remove();
                
                // Add the new membership card
                var container = document.getElementById('serviceAreaMemberships');
                var div = document.createElement('div');
                div.innerHTML = html;
                container.appendChild(div.firstElementChild);
                
                // If isPrimary, update checkbox and clear others
                if (isPrimary) {
                    setPrimaryServiceArea(membershipIndex);
                }
                
                // Track added service area
                addedServiceAreas.push(serviceAreaId);
                membershipIndex++;
                
                // Reset and close modal
                select.value = '';
                document.getElementById('newIsPrimary').checked = false;
                addModal.hide();
            });
    });
    
    // Update dropdown to disable already-added service areas
    function updateServiceAreaDropdown() {
        var select = document.getElementById('newServiceAreaId');
        var options = select.querySelectorAll('option');
        options.forEach(function(opt) {
            if (opt.value && addedServiceAreas.includes(opt.value)) {
                opt.disabled = true;
                opt.textContent = opt.dataset.code + ' - ' + opt.dataset.name + ' (already added)';
            } else if (opt.value) {
                opt.disabled = false;
                opt.textContent = opt.dataset.code + ' - ' + opt.dataset.name;
            }
        });
    }
    
    // Remove membership
    document.getElementById('serviceAreaMemberships').addEventListener('click', function(e) {
        var removeBtn = e.target.closest('.remove-membership-btn');
        if (removeBtn) {
            var card = removeBtn.closest('.sa-membership-card');
            var serviceAreaId = card.dataset.serviceAreaId;
            
            // Remove from tracking array
            var idx = addedServiceAreas.indexOf(serviceAreaId);
            if (idx > -1) addedServiceAreas.splice(idx, 1);
            
            // Remove the card
            card.remove();
            
            // Show "no memberships" message if empty
            var container = document.getElementById('serviceAreaMemberships');
            if (container.querySelectorAll('.sa-membership-card').length === 0) {
                container.innerHTML = '<div id="noMembershipsMessage" class="text-center text-muted py-4">' +
                    '<i class="bi bi-diagram-3 display-6 d-block mb-2"></i>' +
                    'No service area memberships. Click "Add Service Area" to add one.</div>';
            }
            
            // Reindex remaining memberships
            reindexMemberships();
        }
    });
    
    // Handle Primary checkbox changes
    document.getElementById('serviceAreaMemberships').addEventListener('change', function(e) {
        if (e.target.classList.contains('primary-checkbox') && e.target.checked) {
            var card = e.target.closest('.sa-membership-card');
            var index = parseInt(card.dataset.index);
            setPrimaryServiceArea(index);
        }
    });
    
    // Set primary service area (uncheck others)
    function setPrimaryServiceArea(primaryIndex) {
        var checkboxes = document.querySelectorAll('.primary-checkbox');
        checkboxes.forEach(function(cb) {
            var card = cb.closest('.sa-membership-card');
            var idx = parseInt(card.dataset.index);
            cb.checked = (idx === primaryIndex);
            
            // Update badge
            var badge = card.querySelector('.primary-badge');
            if (idx === primaryIndex) {
                badge.classList.remove('d-none');
            } else {
                badge.classList.add('d-none');
            }
        });
    }
    
    // Reindex memberships after removal
    function reindexMemberships() {
        var cards = document.querySelectorAll('.sa-membership-card');
        cards.forEach(function(card, newIndex) {
            card.dataset.index = newIndex;
            
            // Update all input names
            card.querySelectorAll('input, select').forEach(function(input) {
                var name = input.name;
                if (name) {
                    input.name = name.replace(/\[\d+\]/, '[' + newIndex + ']');
                }
                var id = input.id;
                if (id) {
                    input.id = id.replace(/_\d+$/, '_' + newIndex);
                }
            });
            
            // Update labels
            card.querySelectorAll('label').forEach(function(label) {
                var forAttr = label.getAttribute('for');
                if (forAttr) {
                    label.setAttribute('for', forAttr.replace(/_\d+$/, '_' + newIndex));
                }
            });
        });
        
        membershipIndex = cards.length;
    }
})();
</script>
}
