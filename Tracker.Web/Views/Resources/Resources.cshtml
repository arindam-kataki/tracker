@model Tracker.Web.ViewModels.ResourcesViewModel
@{
    ViewData["Title"] = "Resources";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">
        <i class="bi bi-people me-2"></i>Resources
        <small class="text-muted fs-6">(@Model.ActiveCount active of @Model.TotalCount)</small>
    </h4>
</div>

@Html.AntiForgeryToken()

<div class="toolbar mb-3">
    @if (User.IsInRole("SuperAdmin"))
    {
        <button class="btn btn-primary" id="addBtn">
            <i class="bi bi-plus-lg me-1"></i> Add Resource
        </button>
    }
</div>

<!-- Filter -->
<div class="card mb-3">
    <div class="card-body py-2">
        <form method="get" class="row g-2 align-items-center">
            <div class="col-md-4">
                <input type="text" name="search" class="form-control form-control-sm" 
                       placeholder="Search name or email..." value="@Model.SearchTerm" />
            </div>
            <div class="col-md-3">
                <select name="type" class="form-select form-select-sm">
                    <option value="">All Types</option>
                    @foreach (var item in Model.ResourceTypes)
                    {
                        <option value="@item.Value" selected="@(item.Value == Model.TypeFilter)">@item.Text</option>
                    }
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-search"></i> Filter
                </button>
                @if (!string.IsNullOrEmpty(Model.SearchTerm) || !string.IsNullOrEmpty(Model.TypeFilter))
                {
                    <a href="@Url.Action("Index")" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-x-lg"></i> Clear
                    </a>
                }
            </div>
        </form>
    </div>
</div>

<!-- Table -->
<div class="card">
    <div class="card-body p-0">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Email</th>
                    <th>Skills</th>
                    <th style="width: 80px;">Status</th>
                    @if (User.IsInRole("SuperAdmin"))
                    {
                        <th style="width: 100px;">Actions</th>
                    }
                </tr>
            </thead>
            <tbody>
                @if (!Model.Resources.Any())
                {
                    <tr>
                        <td colspan="@(User.IsInRole("SuperAdmin") ? 6 : 5)" class="text-center text-muted py-4">
                            <i class="bi bi-inbox display-6 d-block mb-2"></i>
                            No resources found.
                        </td>
                    </tr>
                }
                @foreach (var resource in Model.Resources)
                {
                    <tr class="@(!resource.IsActive ? "table-secondary" : "")">
                        <td><strong>@resource.Name</strong></td>
                        <td>
                            @if (!string.IsNullOrEmpty(resource.ResourceTypeName))
                            {
                                <span class="badge bg-secondary">@resource.ResourceTypeName</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td class="text-muted">
                            @if (!string.IsNullOrEmpty(resource.Email))
                            {
                                <a href="mailto:@resource.Email" class="text-decoration-none">@resource.Email</a>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </td>
                        <td>
                            @if (resource.SkillNames.Any())
                            {
                                <span title="@resource.SkillsDisplay">
                                    @(resource.SkillNames.Count > 2 
                                        ? string.Join(", ", resource.SkillNames.Take(2)) + $" +{resource.SkillNames.Count - 2} more"
                                        : resource.SkillsDisplay)
                                </span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if (resource.IsActive)
                            {
                                <span class="badge bg-success">Active</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inactive</span>
                            }
                        </td>
                        @if (User.IsInRole("SuperAdmin"))
                        {
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-outline-primary edit-btn" 
                                            data-id="@resource.Id" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-danger delete-btn" 
                                            data-id="@resource.Id" data-name="@resource.Name" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" id="editModalContent">
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteResourceName"></strong>?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
(function() {
    var editModal = new bootstrap.Modal(document.getElementById('editModal'));
    var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    var deleteId = null;

    // Add button
    document.getElementById('addBtn')?.addEventListener('click', function() {
        loadEditForm('');
    });

    // Edit buttons
    document.querySelectorAll('.edit-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            loadEditForm(this.dataset.id);
        });
    });

    // Delete buttons
    document.querySelectorAll('.delete-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            deleteId = this.dataset.id;
            document.getElementById('deleteResourceName').textContent = this.dataset.name;
            deleteModal.show();
        });
    });

    // Confirm delete
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (!deleteId) return;
        
        var token = document.querySelector('input[name="__RequestVerificationToken"]').value;
        
        fetch('/resources/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': token
            },
            body: 'id=' + encodeURIComponent(deleteId)
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting resource');
            }
        });
    });

    function loadEditForm(id) {
        var url = '/resources/edit' + (id ? '?id=' + encodeURIComponent(id) : '');
        
        fetch(url)
            .then(function(response) { return response.text(); })
            .then(function(html) {
                document.getElementById('editModalContent').innerHTML = html;
                editModal.show();
                bindFormSubmit();
            });
    }

    function bindFormSubmit() {
        var form = document.getElementById('editResourceForm');
        if (!form) return;
        
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            var formData = new FormData(form);
            
            fetch('/resources/save', {
                method: 'POST',
                body: formData
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    editModal.hide();
                    location.reload();
                } else {
                    // Reload form with errors
                    fetch(form.action, { method: 'POST', body: formData })
                        .then(function(r) { return r.text(); })
                        .then(function(html) {
                            document.getElementById('editModalContent').innerHTML = html;
                            bindFormSubmit();
                        });
                }
            });
        });
    }
})();
</script>
}
