@model Tracker.Web.ViewModels.ResourceEditViewModel
@using Tracker.Web.Entities
@{
    ViewData["Title"] = Model.IsNew ? "Create User" : "Edit User";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">
        <i class="bi bi-@(Model.IsNew ? "person-plus" : "pencil") me-2"></i>@ViewData["Title"]
    </h4>
    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Back to List
    </a>
</div>

<form method="post" asp-action="Save" id="userForm">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    
    <div class="row">
        <!-- Left Column: Basic Info -->
        <div class="col-lg-5">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-person me-2"></i>Basic Information</h5>
                </div>
                <div class="card-body">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                    
                    <div class="mb-3">
                        <label asp-for="Name" class="form-label">Name <span class="text-danger">*</span></label>
                        <input asp-for="Name" class="form-control" />
                        <span asp-validation-for="Name" class="text-danger small"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="Email" class="form-label">Email</label>
                        <input asp-for="Email" class="form-control" type="email" />
                        <span asp-validation-for="Email" class="text-danger small"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="Phone" class="form-label">Phone</label>
                        <input asp-for="Phone" class="form-control" />
                        <span asp-validation-for="Phone" class="text-danger small"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="OrganizationType" class="form-label">Organization Type <span class="text-danger">*</span></label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="OrganizationType" id="orgClient" value="0" 
                                   @(Model.OrganizationType == OrganizationType.Client ? "checked" : "") onchange="onOrgTypeChange()">
                            <label class="btn btn-outline-info" for="orgClient">Client</label>
                            
                            <input type="radio" class="btn-check" name="OrganizationType" id="orgImplementor" value="1"
                                   @(Model.OrganizationType == OrganizationType.Implementor ? "checked" : "") onchange="onOrgTypeChange()">
                            <label class="btn btn-outline-primary" for="orgImplementor">Implementor</label>
                            
                            <input type="radio" class="btn-check" name="OrganizationType" id="orgVendor" value="2"
                                   @(Model.OrganizationType == OrganizationType.Vendor ? "checked" : "") onchange="onOrgTypeChange()">
                            <label class="btn btn-outline-warning" for="orgVendor">Vendor</label>
                        </div>
                    </div>
                    
                    <hr />
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" asp-for="IsActive" />
                            <label class="form-check-label" asp-for="IsActive">Active</label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="canLoginGroup">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" asp-for="CanLogin" onchange="onCanLoginChange()" />
                            <label class="form-check-label" asp-for="CanLogin">Can Login</label>
                        </div>
                        <small class="text-muted">Allow this user to sign into the system</small>
                    </div>
                    
                    <div class="mb-3" id="passwordGroup" style="display: @(Model.CanLogin ? "block" : "none");">
                        <label asp-for="Password" class="form-label">
                            @(Model.IsNew ? "Password" : "New Password")
                            @if (Model.IsNew)
                            {
                                <span class="text-danger">*</span>
                            }
                        </label>
                        <input asp-for="Password" class="form-control" type="password" autocomplete="new-password" />
                        <span asp-validation-for="Password" class="text-danger small"></span>
                        @if (!Model.IsNew)
                        {
                            <small class="text-muted">Leave blank to keep current password</small>
                        }
                    </div>
                    
                    <div class="mb-0" id="isAdminGroup" style="display: @(Model.OrganizationType == OrganizationType.Implementor ? "block" : "none");">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" asp-for="IsAdmin" />
                            <label class="form-check-label" asp-for="IsAdmin">
                                <i class="bi bi-shield-check text-danger me-1"></i>Administrator
                            </label>
                        </div>
                        <small class="text-muted">Full system access - bypasses all permissions</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Service Areas -->
        <div class="col-lg-7">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Service Area Access</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addServiceArea()">
                        <i class="bi bi-plus-lg me-1"></i>Add Service Area
                    </button>
                </div>
                <div class="card-body" id="serviceAreasContainer">
                    @if (!Model.ServiceAreas.Any())
                    {
                        <div id="noServiceAreasMessage" class="text-center text-muted py-4">
                            <i class="bi bi-inbox display-6 d-block mb-2"></i>
                            <p class="mb-0">No service areas assigned</p>
                            <p class="small">Click "Add Service Area" to grant access</p>
                        </div>
                    }
                    
                    @for (var i = 0; i < Model.ServiceAreas.Count; i++)
                    {
                        var sa = Model.ServiceAreas[i];
                        <div class="service-area-card border rounded p-3 mb-3" data-index="@i">
                            <input type="hidden" name="ServiceAreas[@i].ServiceAreaId" value="@sa.ServiceAreaId" />
                            
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h6 class="mb-1">
                                        <span class="badge bg-secondary me-2">@(Model.AvailableServiceAreas.FirstOrDefault(x => x.Id == sa.ServiceAreaId)?.Code ?? "?")</span>
                                        @(sa.ServiceAreaName ?? Model.AvailableServiceAreas.FirstOrDefault(x => x.Id == sa.ServiceAreaId)?.Name ?? "Unknown")
                                    </h6>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="ServiceAreas[@i].IsPrimary" value="true" @(sa.IsPrimary ? "checked" : "") />
                                        <label class="form-check-label small">Primary</label>
                                    </div>
                                </div>
                                <div>
                                    <select class="form-select form-select-sm d-inline-block me-2" style="width: auto;" onchange="applyTemplate(this, @i)">
                                        <option value="">Apply Template...</option>
                                        <option value="spoc">SPOC / Lead</option>
                                        <option value="developer">Developer</option>
                                        <option value="tester">Tester</option>
                                        <option value="analyst">Analyst</option>
                                        <option value="finance-view">Finance (View)</option>
                                        <option value="finance-approve">Finance (Approve)</option>
                                        <option value="hr">HR</option>
                                        <option value="reporting">Reporting</option>
                                    </select>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeServiceArea(this)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <div class="border rounded p-2 h-100">
                                        <div class="fw-semibold small mb-2 text-primary">Enhancements</div>
                                        <div class="form-check">
                                            <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[@i].CanViewEnhancements" value="true" @(sa.CanViewEnhancements ? "checked" : "") data-perm="ViewEnhancements" />
                                            <label class="form-check-label small">View</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[@i].CanEditEnhancements" value="true" @(sa.CanEditEnhancements ? "checked" : "") data-perm="EditEnhancements" />
                                            <label class="form-check-label small">Edit</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[@i].CanUploadEnhancements" value="true" @(sa.CanUploadEnhancements ? "checked" : "") data-perm="UploadEnhancements" />
                                            <label class="form-check-label small">Upload</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-2 h-100">
                                        <div class="fw-semibold small mb-2 text-success">Timesheets</div>
                                        <div class="form-check">
                                            <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[@i].CanLogTimesheet" value="true" @(sa.CanLogTimesheet ? "checked" : "") data-perm="LogTimesheet" />
                                            <label class="form-check-label small">Log Own</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[@i].CanViewAllTimesheets" value="true" @(sa.CanViewAllTimesheets ? "checked" : "") data-perm="ViewAllTimesheets" />
                                            <label class="form-check-label small">View All</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[@i].CanApproveTimesheets" value="true" @(sa.CanApproveTimesheets ? "checked" : "") data-perm="ApproveTimesheets" />
                                            <label class="form-check-label small">Approve</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-2 h-100">
                                        <div class="fw-semibold small mb-2 text-warning">Consolidation</div>
                                        <div class="form-check">
                                            <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[@i].CanViewConsolidation" value="true" @(sa.CanViewConsolidation ? "checked" : "") data-perm="ViewConsolidation" />
                                            <label class="form-check-label small">View</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[@i].CanCreateConsolidation" value="true" @(sa.CanCreateConsolidation ? "checked" : "") data-perm="CreateConsolidation" />
                                            <label class="form-check-label small">Create</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[@i].CanFinalizeConsolidation" value="true" @(sa.CanFinalizeConsolidation ? "checked" : "") data-perm="FinalizeConsolidation" />
                                            <label class="form-check-label small">Finalize</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-2 h-100">
                                        <div class="fw-semibold small mb-2 text-info">Other</div>
                                        <div class="form-check">
                                            <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[@i].CanViewResources" value="true" @(sa.CanViewResources ? "checked" : "") data-perm="ViewResources" />
                                            <label class="form-check-label small">View Resources</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[@i].CanManageResources" value="true" @(sa.CanManageResources ? "checked" : "") data-perm="ManageResources" />
                                            <label class="form-check-label small">Manage Resources</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[@i].CanViewReports" value="true" @(sa.CanViewReports ? "checked" : "") data-perm="ViewReports" />
                                            <label class="form-check-label small">View Reports</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <div class="d-flex justify-content-end gap-2">
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg me-1"></i>@(Model.IsNew ? "Create User" : "Save Changes")
        </button>
    </div>
</form>

<!-- Add Service Area Modal -->
<div class="modal fade" id="addServiceAreaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Service Area</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Service Area</label>
                    <select id="newServiceAreaId" class="form-select">
                        <option value="">Select...</option>
                        @foreach (var sa in Model.AvailableServiceAreas)
                        {
                            <option value="@sa.Id" data-code="@sa.Code" data-name="@sa.Name">@sa.Code - @sa.Name</option>
                        }
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Template</label>
                    <select id="newServiceAreaTemplate" class="form-select">
                        <option value="view-only">View Only</option>
                        <option value="developer">Developer</option>
                        <option value="tester">Tester</option>
                        <option value="analyst">Analyst</option>
                        <option value="spoc">SPOC / Lead</option>
                        <option value="finance-view">Finance (View)</option>
                        <option value="finance-approve">Finance (Approve)</option>
                        <option value="hr">HR</option>
                        <option value="reporting">Reporting</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmAddServiceArea()">Add</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        let serviceAreaIndex = @Model.ServiceAreas.Count;
        const serviceAreas = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.AvailableServiceAreas.Select(sa => new { sa.Id, sa.Code, sa.Name })));
        
        const templates = {
            'spoc': { ViewEnhancements: true, EditEnhancements: true, UploadEnhancements: true, LogTimesheet: true, ViewAllTimesheets: true, ApproveTimesheets: true, ViewConsolidation: true, CreateConsolidation: true, ViewResources: true, ViewReports: true },
            'developer': { ViewEnhancements: true, LogTimesheet: true, ViewResources: true },
            'tester': { ViewEnhancements: true, LogTimesheet: true, ViewResources: true },
            'analyst': { ViewEnhancements: true, LogTimesheet: true, ViewResources: true },
            'finance-view': { ViewEnhancements: true, ViewConsolidation: true, ViewReports: true },
            'finance-approve': { ViewEnhancements: true, ViewConsolidation: true, CreateConsolidation: true, FinalizeConsolidation: true, ViewReports: true },
            'hr': { ViewResources: true, ManageResources: true },
            'reporting': { ViewEnhancements: true, ViewConsolidation: true, ViewReports: true },
            'view-only': { ViewEnhancements: true, ViewResources: true }
        };
        
        function onOrgTypeChange() {
            const orgType = document.querySelector('input[name="OrganizationType"]:checked').value;
            const canLoginGroup = document.getElementById('canLoginGroup');
            const isAdminGroup = document.getElementById('isAdminGroup');
            const canLoginCheckbox = document.getElementById('CanLogin');
            const isAdminCheckbox = document.getElementById('IsAdmin');
            
            // Client cannot login
            if (orgType === '0') {
                canLoginGroup.style.display = 'none';
                canLoginCheckbox.checked = false;
                onCanLoginChange();
            } else {
                canLoginGroup.style.display = 'block';
            }
            
            // Only Implementor can be admin
            if (orgType === '1') {
                isAdminGroup.style.display = 'block';
            } else {
                isAdminGroup.style.display = 'none';
                isAdminCheckbox.checked = false;
            }
        }
        
        function onCanLoginChange() {
            const canLogin = document.getElementById('CanLogin').checked;
            document.getElementById('passwordGroup').style.display = canLogin ? 'block' : 'none';
        }
        
        function addServiceArea() {
            document.getElementById('newServiceAreaId').value = '';
            document.getElementById('newServiceAreaTemplate').value = 'view-only';
            new bootstrap.Modal(document.getElementById('addServiceAreaModal')).show();
        }
        
        function confirmAddServiceArea() {
            const select = document.getElementById('newServiceAreaId');
            const saId = select.value;
            if (!saId) {
                alert('Please select a service area');
                return;
            }
            
            // Check if already added
            const existing = document.querySelector(`input[name^="ServiceAreas"][value="${saId}"]`);
            if (existing) {
                alert('This service area is already added');
                return;
            }
            
            const option = select.options[select.selectedIndex];
            const saCode = option.dataset.code;
            const saName = option.dataset.name;
            const template = document.getElementById('newServiceAreaTemplate').value;
            const perms = templates[template] || templates['view-only'];
            
            const html = createServiceAreaCard(serviceAreaIndex, saId, saCode, saName, perms);
            
            const noMsg = document.getElementById('noServiceAreasMessage');
            if (noMsg) noMsg.remove();
            
            document.getElementById('serviceAreasContainer').insertAdjacentHTML('beforeend', html);
            serviceAreaIndex++;
            
            bootstrap.Modal.getInstance(document.getElementById('addServiceAreaModal')).hide();
        }
        
        function createServiceAreaCard(index, saId, saCode, saName, perms) {
            return `
                <div class="service-area-card border rounded p-3 mb-3" data-index="${index}">
                    <input type="hidden" name="ServiceAreas[${index}].ServiceAreaId" value="${saId}" />
                    
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h6 class="mb-1">
                                <span class="badge bg-secondary me-2">${saCode}</span>
                                ${saName}
                            </h6>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="ServiceAreas[${index}].IsPrimary" value="true" />
                                <label class="form-check-label small">Primary</label>
                            </div>
                        </div>
                        <div>
                            <select class="form-select form-select-sm d-inline-block me-2" style="width: auto;" onchange="applyTemplate(this, ${index})">
                                <option value="">Apply Template...</option>
                                <option value="spoc">SPOC / Lead</option>
                                <option value="developer">Developer</option>
                                <option value="tester">Tester</option>
                                <option value="analyst">Analyst</option>
                                <option value="finance-view">Finance (View)</option>
                                <option value="finance-approve">Finance (Approve)</option>
                                <option value="hr">HR</option>
                                <option value="reporting">Reporting</option>
                            </select>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeServiceArea(this)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="row g-2">
                        <div class="col-md-3">
                            <div class="border rounded p-2 h-100">
                                <div class="fw-semibold small mb-2 text-primary">Enhancements</div>
                                <div class="form-check">
                                    <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[${index}].CanViewEnhancements" value="true" ${perms.ViewEnhancements ? 'checked' : ''} data-perm="ViewEnhancements" />
                                    <label class="form-check-label small">View</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[${index}].CanEditEnhancements" value="true" ${perms.EditEnhancements ? 'checked' : ''} data-perm="EditEnhancements" />
                                    <label class="form-check-label small">Edit</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[${index}].CanUploadEnhancements" value="true" ${perms.UploadEnhancements ? 'checked' : ''} data-perm="UploadEnhancements" />
                                    <label class="form-check-label small">Upload</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2 h-100">
                                <div class="fw-semibold small mb-2 text-success">Timesheets</div>
                                <div class="form-check">
                                    <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[${index}].CanLogTimesheet" value="true" ${perms.LogTimesheet ? 'checked' : ''} data-perm="LogTimesheet" />
                                    <label class="form-check-label small">Log Own</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[${index}].CanViewAllTimesheets" value="true" ${perms.ViewAllTimesheets ? 'checked' : ''} data-perm="ViewAllTimesheets" />
                                    <label class="form-check-label small">View All</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[${index}].CanApproveTimesheets" value="true" ${perms.ApproveTimesheets ? 'checked' : ''} data-perm="ApproveTimesheets" />
                                    <label class="form-check-label small">Approve</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2 h-100">
                                <div class="fw-semibold small mb-2 text-warning">Consolidation</div>
                                <div class="form-check">
                                    <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[${index}].CanViewConsolidation" value="true" ${perms.ViewConsolidation ? 'checked' : ''} data-perm="ViewConsolidation" />
                                    <label class="form-check-label small">View</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[${index}].CanCreateConsolidation" value="true" ${perms.CreateConsolidation ? 'checked' : ''} data-perm="CreateConsolidation" />
                                    <label class="form-check-label small">Create</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[${index}].CanFinalizeConsolidation" value="true" ${perms.FinalizeConsolidation ? 'checked' : ''} data-perm="FinalizeConsolidation" />
                                    <label class="form-check-label small">Finalize</label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-2 h-100">
                                <div class="fw-semibold small mb-2 text-info">Other</div>
                                <div class="form-check">
                                    <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[${index}].CanViewResources" value="true" ${perms.ViewResources ? 'checked' : ''} data-perm="ViewResources" />
                                    <label class="form-check-label small">View Resources</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[${index}].CanManageResources" value="true" ${perms.ManageResources ? 'checked' : ''} data-perm="ManageResources" />
                                    <label class="form-check-label small">Manage Resources</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input perm-checkbox" type="checkbox" name="ServiceAreas[${index}].CanViewReports" value="true" ${perms.ViewReports ? 'checked' : ''} data-perm="ViewReports" />
                                    <label class="form-check-label small">View Reports</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function removeServiceArea(btn) {
            if (confirm('Remove this service area?')) {
                btn.closest('.service-area-card').remove();
                reindexServiceAreas();
            }
        }
        
        function reindexServiceAreas() {
            const cards = document.querySelectorAll('.service-area-card');
            cards.forEach((card, index) => {
                card.querySelectorAll('input, select').forEach(input => {
                    if (input.name) {
                        input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
                    }
                });
            });
            serviceAreaIndex = cards.length;
        }
        
        function applyTemplate(select, index) {
            const template = select.value;
            if (!template) return;
            
            const card = select.closest('.service-area-card');
            const perms = templates[template] || {};
            
            // Uncheck all
            card.querySelectorAll('.perm-checkbox').forEach(cb => cb.checked = false);
            
            // Check based on template
            Object.keys(perms).forEach(perm => {
                const cb = card.querySelector(`[data-perm="${perm}"]`);
                if (cb) cb.checked = perms[perm];
            });
            
            select.value = '';
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            onOrgTypeChange();
            onCanLoginChange();
        });
    </script>
}
